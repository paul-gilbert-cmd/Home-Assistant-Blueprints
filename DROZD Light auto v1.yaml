blueprint:
  name: "DROZD Light auto v1"

  domain: automation

  input:
    motion_sensors:
      name: "Датчики движения/присутствия"
      description: "Выберите один или несколько binary_sensor (состояние 'on' = движение/присутствие)."
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    target_entities:
      name: "Целевые свет/выключатели"
      description: "Выберите управляемые сущности (light и/или switch)."
      selector:
        target:
          entity:
            domain:
              - light
              - switch

    manual_entities:
      name: "Сущности для отслеживания ручного включения"
      description: "Конкретные light/switch, для которых нужно авто-выключение при ручном включении."
      selector:
        entity:
          domain:
            - light
            - switch
          multiple: true

    day_timeout_seconds:
      name: "Таймаут авто-выключения днём (сек)"
      description: "Через сколько секунд выключать при отсутствии движения днём."
      default: 120
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    night_timeout_seconds:
      name: "Таймаут авто-выключения ночью (сек)"
      description: "Через сколько секунд выключать при отсутствии движения ночью."
      default: 30
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    enable_night_mode:
      name: "Включить ночной режим"
      description: "Если выключено — всегда считается день."
      default: true
      selector:
        boolean: {}

    night_mode_source:
      name: "Источник ночного режима"
      description: "Солнце, солнце со смещением или расписание."
      default: sun
      selector:
        select:
          options:
            - label: "Солнце (ниже/выше горизонта)"
              value: sun
            - label: "Солнце со смещением"
              value: sun_offset
            - label: "Расписание (начало/конец)"
              value: schedule

    sunset_offset_minutes:
      name: "Смещение от заката (мин)"
      description: "Отрицательное = до заката, положительное = после."
      default: -60
      selector:
        number:
          min: -720
          max: 720
          unit_of_measurement: minutes
          mode: box

    sunrise_offset_minutes:
      name: "Смещение от восхода (мин)"
      description: "Отрицательное = до восхода, положительное = после."
      default: 60
      selector:
        number:
          min: -720
          max: 720
          unit_of_measurement: minutes
          mode: box

    schedule_night_start:
      name: "Начало ночи (расписание)"
      description: "Используется только при источнике 'Расписание'."
      default: "23:30:00"
      selector:
        time: {}

    schedule_night_end:
      name: "Конец ночи (расписание)"
      description: "Используется только при источнике 'Расписание'."
      default: "07:0:00"
      selector:
        time: {}

    day_scene:
      name: "Дневная сцена"
      description: "Применяется при переходе в день."
      selector:
        entity:
          domain: scene
          multiple: false

    night_scene:
      name: "Ночная сцена"
      description: "Применяется при переходе в ночь."
      selector:
        entity:
          domain: scene
          multiple: false

    apply_scene_on_mode_change:
      name: "Применять сцены при смене режима"
      description: "Автоматически применять выбранные сцены."
      default: true
      selector:
        boolean: {}

    manual_on_auto_off_enabled:
      name: "Авто-выключение при ручном включении"
      description: "Выключать вручную включённый свет по таймауту."
      default: true
      selector:
        boolean: {}

    manual_on_day_timeout_seconds:
      name: "Ручное включение: таймаут днём (сек)"
      description: "Через сколько секунд выключить вручную включённый свет днём."
      default: 600
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    manual_on_night_timeout_seconds:
      name: "Ручное включение: таймаут ночью (сек)"
      description: "Через сколько секунд выключить вручную включённый свет ночью."
      default: 300
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    enable_day_auto_on:
      name: "Авто-включение днём"
      description: "Разрешить включение по движению днём."
      default: true
      selector:
        boolean: {}

    enable_day_auto_off:
      name: "Авто-выключение днём"
      description: "Разрешить выключение по таймауту днём."
      default: true
      selector:
        boolean: {}

    enable_night_auto_on:
      name: "Авто-включение ночью"
      description: "Разрешить включение по движению ночью."
      default: true
      selector:
        boolean: {}

    enable_night_auto_off:
      name: "Авто-выключение ночью"
      description: "Разрешить выключение по таймауту ночью."
      default: true
      selector:
        boolean: {}

variables:
  motion_sensors: !input motion_sensors
  target_entities: !input target_entities
  manual_entities: !input manual_entities

  day_timeout_seconds: !input day_timeout_seconds
  night_timeout_seconds: !input night_timeout_seconds
  manual_on_day_timeout_seconds: !input manual_on_day_timeout_seconds
  manual_on_night_timeout_seconds: !input manual_on_night_timeout_seconds

  enable_night_mode: !input enable_night_mode
  night_mode_source: !input night_mode_source
  schedule_night_start: !input schedule_night_start
  schedule_night_end: !input schedule_night_end

  sunset_offset_minutes: !input sunset_offset_minutes
  sunrise_offset_minutes: !input sunrise_offset_minutes
  sunset_offset_seconds: "{{ (sunset_offset_minutes | int) * 60 }}"
  sunrise_offset_seconds: "{{ (sunrise_offset_minutes | int) * 60 }}"

  day_scene: !input day_scene
  night_scene: !input night_scene
  apply_scene_on_mode_change: !input apply_scene_on_mode_change
  manual_on_auto_off_enabled: !input manual_on_auto_off_enabled

  enable_day_auto_on: !input enable_day_auto_on
  enable_day_auto_off: !input enable_day_auto_off
  enable_night_auto_on: !input enable_night_auto_on
  enable_night_auto_off: !input enable_night_auto_off

  is_night_sun: "{{ states('sun.sun') == 'below_horizon' }}"
  is_night_sun_offset: >
    {% set now_ts = as_timestamp(now()) %}
    {% set next_set = state_attr('sun.sun','next_setting') %}
    {% set next_rise = state_attr('sun.sun','next_rising') %}
    {% if not next_set or not next_rise %}
      {{ states('sun.sun') == 'below_horizon' }}
    {% else %}
      {% set next_set_ts = as_timestamp(next_set) + sunset_offset_seconds %}
      {% set next_rise_ts = as_timestamp(next_rise) + sunrise_offset_seconds %}
      {% if states('sun.sun') == 'above_horizon' %}
        {{ now_ts >= next_set_ts }}
      {% else %}
        {{ now_ts <= next_rise_ts }}
      {% endif %}
    {% endif %}
  is_night_schedule: >
    {% set start = schedule_night_start %}
    {% set end = schedule_night_end %}
    {% set now_time = now().time() %}
    {% set start_time = as_datetime(strptime(start,'%H:%M:%S')).time() %}
    {% set end_time = as_datetime(strptime(end,'%H:%M:%S')).time() %}
    {% if start_time <= end_time %}
      {{ start_time <= now_time <= end_time }}
    {% else %}
      {{ now_time >= start_time or now_time <= end_time }}
    {% endif %}
  is_night: >
    {% if not enable_night_mode %}
      false
    {% elif night_mode_source == 'schedule' %}
      {{ is_night_schedule }}
    {% elif night_mode_source == 'sun_offset' %}
      {{ is_night_sun_offset }}
    {% else %}
      {{ is_night_sun }}
    {% endif %}

  motion_timeout_seconds: "{{ night_timeout_seconds if is_night else day_timeout_seconds }}"
  manual_timeout_seconds: "{{ manual_on_night_timeout_seconds if is_night else manual_on_day_timeout_seconds }}"
  allow_auto_on: "{{ enable_night_auto_on if is_night else enable_day_auto_on }}"
  allow_auto_off: "{{ enable_night_auto_off if is_night else enable_day_auto_off }}"

mode: restart
max_exceeded: silent

trigger:
  # Включить свет при движении
  - id: motion_on
    platform: state
    entity_id: !input motion_sensors
    to: 'on'

  # Смена режима по солнцу
  - id: sun_rises
    platform: state
    entity_id: sun.sun
    to: 'above_horizon'

  - id: sun_sets
    platform: state
    entity_id: sun.sun
    to: 'below_horizon'

  # Смена режима по расписанию
  - id: schedule_night_start_trigger
    platform: time
    at: !input schedule_night_start

  - id: schedule_night_end_trigger
    platform: time
    at: !input schedule_night_end

  # Ручное включение света: конкретный список manual_entities
  - id: manual_on
    platform: state
    entity_id: !input manual_entities
    to: 'on'

condition: []

action:
  - choose:

      # 1) Авто-включение по движению (если разрешено)
      - conditions:
          - condition: trigger
            id: motion_on
          - condition: template
            value_template: "{{ allow_auto_on }}"
        sequence:
          - service: homeassistant.turn_on
            target: !input target_entities
          # Ожидание прекращения движения и таймаута, затем выключение (если разрешено авто-выключение)
          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: 'off'
            continue_on_timeout: false
          - delay:
              seconds: "{{ motion_timeout_seconds | int }}"
          - condition: template
            value_template: "{{ allow_auto_off }}"
          # Перед выключением проверим, что нет активного движения
          - condition: template
            value_template: >
              {{ expand(motion_sensors) | selectattr('state','eq','on') | list | count == 0 }}
          - service: homeassistant.turn_off
            target: !input target_entities

      # 2) Применить ночную сцену при входе в ночной режим
      - conditions:
          - condition: template
            value_template: >
              {{ apply_scene_on_mode_change and enable_night_mode and (
                (trigger.id == 'sun_sets' and night_mode_source in ['sun','sun_offset']) or
                (trigger.id == 'schedule_night_start_trigger' and night_mode_source == 'schedule')
              ) }}
        sequence:
          - condition: template
            value_template: "{{ night_scene is not none }}"
          - service: scene.turn_on
            target:
              entity_id: "{{ night_scene }}"

      # 3) Применить дневную сцену при входе в дневной режим
      - conditions:
          - condition: template
            value_template: >
              {{ apply_scene_on_mode_change and (
                (trigger.id == 'sun_rises' and night_mode_source in ['sun','sun_offset']) or
                (trigger.id == 'schedule_night_end_trigger' and night_mode_source == 'schedule') or
                (not enable_night_mode and trigger.id in [
                  'sun_rises','sun_sets','schedule_night_start_trigger','schedule_night_end_trigger'
                ])
              ) }}
        sequence:
          - condition: template
            value_template: "{{ day_scene is not none }}"
          - service: scene.turn_on
            target:
              entity_id: "{{ day_scene }}"

      # 4) Ручное включение -> если включено, запланировать авто-выключение
      - conditions:
          - condition: trigger
            id: manual_on
          - condition: template
            value_template: "{{ manual_on_auto_off_enabled }}"
          - condition: template
            value_template: >
              {{ (trigger.to_state.context and trigger.to_state.context.user_id) is not none }}
        sequence:
          - delay:
              seconds: "{{ manual_timeout_seconds | int }}"
          # Не выключаем, если есть активное движение
          - condition: template
            value_template: >
              {{ expand(motion_sensors) | selectattr('state','eq','on') | list | count == 0 }}
          - service: homeassistant.turn_off
            target: !input target_entities

    default: []
