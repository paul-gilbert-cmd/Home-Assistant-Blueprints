blueprint:
  name: "DROZD Light auto v1.2 - Освещение по движению — сцена только при первом включении, задержка применения, день/ночь, ручное авто-выключение"
  description: |
    Включение света по движению и выключение по таймауту.
    Сцены применяются ОДИН раз при первом включении после перехода режимов (ночь/день) —
    при этом добавляется настраиваемая задержка между включением света и применением сцены,
    чтобы все устройства стали доступны и гарантированно приняли команды.
    Режимы: день/ночь определяются по солнцу, с возможностью смещения/расписания/отключения.
    Дополнительно — ручное авто-выключение, гибкая активация/выключение для дня/ночи.

  domain: automation

  input:
    motion_sensors:
      name: "Датчики движения/присутствия"
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    target_entities:
      name: "Целевые свет/выключатели"
      selector:
        target:
          entity:
            domain:
              - light
              - switch

    manual_entities:
      name: "Сущности для отслеживания ручного включения"
      selector:
        entity:
          domain:
            - light
            - switch
          multiple: true

    night_scene_pending_flag:
      name: "Флаг ожидания ночной сцены (input_boolean)"
      selector:
        entity:
          domain: input_boolean

    day_scene_pending_flag:
      name: "Флаг ожидания дневной сцены (input_boolean)"
      selector:
        entity:
          domain: input_boolean

    scene_apply_delay:
      name: "Время ожидания перед применением сцены (сек)"
      description: "Сколько ждать между включением света и применением сцены (настройка для гарантии доступности устройств)."
      default: 3
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: seconds
          mode: box

    day_scene:
      name: "Дневная сцена (первое включение)"
      selector:
        entity:
          domain: scene

    night_scene:
      name: "Ночная сцена (первое включение)"
      selector:
        entity:
          domain: scene

    apply_scene_on_mode_change:
      name: "Применять сцену сразу при смене режима"
      default: false
      selector:
        boolean: {}

    day_timeout_seconds:
      name: "Таймаут выключения днём (сек)"
      default: 45
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    night_timeout_seconds:
      name: "Таймаут выключения ночью (сек)"
      default: 30
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    enable_night_mode:
      name: "Использовать ночной режим"
      default: true
      selector:
        boolean: {}

    night_mode_source:
      name: "Источник ночного режима"
      default: sun
      selector:
        select:
          options:
            - label: "Солнце"
              value: sun
            - label: "Солнце со смещением"
              value: sun_offset
            - label: "Расписание"
              value: schedule
            - label: "Отключено"
              value: disabled

    sunset_offset_minutes:
      name: "Смещение от заката (мин)"
      default: -60
      selector:
        number:
          min: -720
          max: 720
          unit_of_measurement: minutes
          mode: box

    sunrise_offset_minutes:
      name: "Смещение от восхода (мин)"
      default: 60
      selector:
        number:
          min: -720
          max: 720
          unit_of_measurement: minutes
          mode: box

    schedule_night_start:
      name: "Начало ночи (расписание)"
      default: "22:00:00"
      selector:
        time: {}

    schedule_night_end:
      name: "Конец ночи (расписание)"
      default: "06:30:00"
      selector:
        time: {}

    enable_day_auto_on:
      name: "Авто-включение днём"
      default: true
      selector:
        boolean: {}

    enable_day_auto_off:
      name: "Авто-выключение днём"
      default: true
      selector:
        boolean: {}

    enable_night_auto_on:
      name: "Авто-включение ночью"
      default: true
      selector:
        boolean: {}

    enable_night_auto_off:
      name: "Авто-выключение ночью"
      default: true
      selector:
        boolean: {}

    manual_on_auto_off_enabled:
      name: "Авто-выключение ручного включения"
      default: true
      selector:
        boolean: {}

    manual_on_day_timeout_seconds:
      name: "Таймаут ручного включения днём (сек)"
      default: 900
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

    manual_on_night_timeout_seconds:
      name: "Таймаут ручного включения ночью (сек)"
      default: 1800
      selector:
        number:
          min: 1
          max: 86400
          unit_of_measurement: seconds
          mode: box

variables:
  motion_sensors: !input motion_sensors
  target_entities: !input target_entities
  manual_entities: !input manual_entities
  night_flag: !input night_scene_pending_flag
  day_flag: !input day_scene_pending_flag
  scene_apply_delay: !input scene_apply_delay

  day_scene: !input day_scene
  night_scene: !input night_scene

  apply_scene_on_mode_change: !input apply_scene_on_mode_change

  day_timeout_seconds: !input day_timeout_seconds
  night_timeout_seconds: !input night_timeout_seconds
  manual_on_day_timeout_seconds: !input manual_on_day_timeout_seconds
  manual_on_night_timeout_seconds: !input manual_on_night_timeout_seconds

  enable_night_mode: !input enable_night_mode
  night_mode_source: !input night_mode_source
  schedule_night_start: !input schedule_night_start
  schedule_night_end: !input schedule_night_end
  sunset_offset_minutes: !input sunset_offset_minutes
  sunrise_offset_minutes: !input sunrise_offset_minutes

  sunset_offset_seconds: "{{ (sunset_offset_minutes | int) * 60 }}"
  sunrise_offset_seconds: "{{ (sunrise_offset_minutes | int) * 60 }}"

  enable_day_auto_on: !input enable_day_auto_on
  enable_day_auto_off: !input enable_day_auto_off
  enable_night_auto_on: !input enable_night_auto_on
  enable_night_auto_off: !input enable_night_auto_off

  manual_on_auto_off_enabled: !input manual_on_auto_off_enabled

  is_night_sun: "{{ states('sun.sun') == 'below_horizon' }}"
  is_night_sun_offset: >
    {% set now_ts = as_timestamp(now()) %}
    {% set next_set = state_attr('sun.sun','next_setting') %}
    {% set next_rise = state_attr('sun.sun','next_rising') %}
    {% if not next_set or not next_rise %}
      {{ states('sun.sun') == 'below_horizon' }}
    {% else %}
      {% set next_set_ts = as_timestamp(next_set) + sunset_offset_seconds %}
      {% set next_rise_ts = as_timestamp(next_rise) + sunrise_offset_seconds %}
      {% if states('sun.sun') == 'above_horizon' %}
        {{ now_ts >= next_set_ts }}
      {% else %}
        {{ now_ts <= next_rise_ts }}
      {% endif %}
    {% endif %}
  is_night_schedule: >
    {% set start = schedule_night_start %}
    {% set end = schedule_night_end %}
    {% set now_time = now().time() %}
    {% set start_time = as_datetime(strptime(start,'%H:%M:%S')).time() %}
    {% set end_time = as_datetime(strptime(end,'%H:%M:%S')).time() %}
    {% if start_time <= end_time %}
      {{ start_time <= now_time <= end_time }}
    {% else %}
      {{ now_time >= start_time or now_time <= end_time }}
    {% endif %}
  is_night: >
    {% if not enable_night_mode or night_mode_source == 'disabled' %}
      false
    {% elif night_mode_source == 'schedule' %}
      {{ is_night_schedule }}
    {% elif night_mode_source == 'sun_offset' %}
      {{ is_night_sun_offset }}
    {% else %}
      {{ is_night_sun }}
    {% endif %}

  motion_timeout_seconds: "{{ night_timeout_seconds if is_night else day_timeout_seconds }}"
  manual_timeout_seconds: "{{ manual_on_night_timeout_seconds if is_night else manual_on_day_timeout_seconds }}"
  allow_auto_on: "{{ enable_night_auto_on if is_night else enable_day_auto_on }}"
  allow_auto_off: "{{ enable_night_auto_off if is_night else enable_day_auto_off }}"

  all_sensors_off: >
    {{ expand(motion_sensors) | selectattr('state','eq','on') | list | count == 0 }}

mode: restart
max_exceeded: silent

trigger:
  - id: motion_on
    platform: state
    entity_id: !input motion_sensors
    to: 'on'

  - id: motion_off
    platform: state
    entity_id: !input motion_sensors
    to: 'off'

  - id: sun_rises
    platform: state
    entity_id: sun.sun
    to: 'above_horizon'

  - id: sun_sets
    platform: state
    entity_id: sun.sun
    to: 'below_horizon'

  - id: schedule_night_start_trigger
    platform: time
    at: !input schedule_night_start

  - id: schedule_night_end_trigger
    platform: time
    at: !input schedule_night_end

  - id: manual_on
    platform: state
    entity_id: !input manual_entities
    to: 'on'

condition: []

action:
  - choose:

      # Установка флагов при переходе в ночь
      - conditions:
          - condition: template
            value_template: >
              {{ (trigger.id == 'sun_sets' and night_mode_source in ['sun','sun_offset']) or
                 (trigger.id == 'schedule_night_start_trigger' and night_mode_source == 'schedule') }}
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ night_flag }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ day_flag }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ apply_scene_on_mode_change and night_scene is not none }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ night_scene }}"

      # Установка флагов при переходе в день
      - conditions:
          - condition: template
            value_template: >
              {{ (trigger.id == 'sun_rises' and night_mode_source in ['sun','sun_offset']) or
                 (trigger.id == 'schedule_night_end_trigger' and night_mode_source == 'schedule') or
                 (not enable_night_mode and trigger.id in [
                   'sun_rises','sun_sets','schedule_night_start_trigger','schedule_night_end_trigger'
                 ]) }}
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ day_flag }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ night_flag }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ apply_scene_on_mode_change and day_scene is not none }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ day_scene }}"

      # Авто-включение по движению (сцена только если флаг активен, с задержкой на devices wakeup)
      - conditions:
          - condition: trigger
            id: motion_on
          - condition: template
            value_template: "{{ allow_auto_on }}"
        sequence:
          # Включаем свет
          - service: homeassistant.turn_on
            target: !input target_entities
          # Применение сцены если "первое включение после перехода" — с задержкой на devices wakeup
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_night and states(night_flag) == 'on' and night_scene is not none }}"
                sequence:
                  - delay:
                      seconds: "{{ scene_apply_delay | int }}"
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ night_scene }}"
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ night_flag }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (not is_night) and states(day_flag) == 'on' and day_scene is not none }}"
                sequence:
                  - delay:
                      seconds: "{{ scene_apply_delay | int }}"
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ day_scene }}"
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ day_flag }}"
            default: []

      # Авто-выключение по таймауту
      - conditions:
          - condition: trigger
            id: motion_off
          - condition: template
            value_template: "{{ allow_auto_off }}"
          - condition: template
            value_template: "{{ all_sensors_off }}"
        sequence:
          - delay:
              seconds: "{{ motion_timeout_seconds | int }}"
          - condition: template
            value_template: "{{ all_sensors_off }}"
          - service: homeassistant.turn_off
            target: !input target_entities

      # Ручное включение (если указаны manual_entities) с первым применением сцены и задержкой, затем таймаут
      - conditions:
          - condition: trigger
            id: manual_on
          - condition: template
            value_template: "{{ manual_on_auto_off_enabled }}"
          - condition: template
            value_template: >
              {{ manual_entities | count > 0 }}
          - condition: template
            value_template: >
              {{ (trigger.to_state.context and trigger.to_state.context.user_id) is not none }}
        sequence:
          # Применение сцены при первом включении после перехода в режим — с задержкой на devices wakeup
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_night and states(night_flag) == 'on' and night_scene is not none }}"
                sequence:
                  - delay:
                      seconds: "{{ scene_apply_delay | int }}"
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ night_scene }}"
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ night_flag }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (not is_night) and states(day_flag) == 'on' and day_scene is not none }}"
                sequence:
                  - delay:
                      seconds: "{{ scene_apply_delay | int }}"
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ day_scene }}"
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ day_flag }}"
            default: []
          # Таймаут авто-выключения
          - delay:
              seconds: "{{ manual_timeout_seconds | int }}"
          - condition: template
            value_template: "{{ all_sensors_off }}"
          - service: homeassistant.turn_off
            target: !input target_entities

    default: []
