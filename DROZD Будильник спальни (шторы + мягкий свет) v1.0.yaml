blueprint:
  name: "DROZD Будильник спальни (шторы + мягкий свет) v1.0"
  description: >
    Умный будильник для спальни с поддержкой будней и выходных,
    мягкого и быстрого сценария пробуждения, управлением светом и шторами,
    а также автоматическим закрытием штор по закату или по фиксированному времени.

    Возможности:
    • Раздельные настройки для будней (пн–пт) и выходных (сб–вс).
    • Два режима пробуждения: мягкий рассвет с постепенным увеличением яркости
      или быстрое пробуждение с ярким светом.
    • Отдельное управление освещением и шторами:
        – можно включать только свет, только шторы или оба элемента вместе;
        – гибкий порядок: сначала шторы, затем свет, или наоборот;
        – настраиваемая задержка между открытием штор и включением света.
    • Поддержка дополнительного реле/розетки:
        – сначала подаётся питание (switch), затем управляется свет (light).
    • Вечерний сценарий:
        – автоматическое закрытие штор в заданное время,
        – либо привязка к закату выбранного sun‑сенсора с настраиваемым оффсетом.

  domain: automation

  input:
    # --- Время будильника ---
    weekday_time:
      name: Время будильника (будни)
      description: >
        Время подъема в будни (понедельник–пятница).
      default: "07:00:00"
      selector:
        time:

    weekend_time:
      name: Время будильника (выходные)
      description: >
        Время подъема в выходные (суббота–воскресенье).
      default: "09:30:00"
      selector:
        time:

    # --- Режим пробуждения ---
    weekday_soft_mode:
      name: Мягкое пробуждение в будни
      description: >
        Если включено — в будни мягкое пробуждение, иначе быстрое.
      default: true
      selector:
        boolean:

    weekend_soft_mode:
      name: Мягкое пробуждение в выходные
      description: >
        Если включено — в выходные мягкое пробуждение, иначе быстрое.
      default: true
      selector:
        boolean:

    # --- Включаемость света и штор ---
    use_light:
      name: Управлять светом
      description: >
        Если выключено — все действия со светом будут пропущены.
      default: true
      selector:
        boolean:

    use_blinds:
      name: Управлять шторами
      description: >
        Если выключено — все действия со шторами будут пропущены.
      default: true
      selector:
        boolean:

    # Порядок: сначала шторы, потом свет или наоборот
    blinds_first:
      name: Сначала шторы, потом свет
      description: >
        Если включено — сначала шторы, задержка, потом свет.
        Если выключено — сначала свет, задержка, потом шторы.
        Флажок влияет только если и свет, и шторы включены.
      default: true
      selector:
        boolean:

    delay_between_blinds_and_light:
      name: Задержка между шторами и светом, сек
      description: >
        Применяется, когда используются и свет, и шторы.
      default: 45
      selector:
        number:
          min: 0
          max: 600
          unit_of_measurement: "сек"
          mode: slider

    # --- Устройства ---
    bedroom_light:
      name: Свет
      description: >
        Диммируемая лампа/светильник.
      selector:
        entity:
          domain: light

    bedroom_cover:
      name: Шторы / жалюзи спальни
      description: >
        Мотор для подъёма/опускания штор.
      selector:
        entity:
          domain: cover

    bedroom_switch:
      name: Выключатель света (опционально)
      description: >
        Выключатель/реле, который подает питание на лампу.
        Если указано, он включается перед действиями со светом.
      default: ""
      selector:
        entity:
          domain:
            - light
            - switch
          multiple: false

    # --- Параметры мягкого пробуждения ---
    soft_start_brightness:
      name: Начальная яркость (мягкое пробуждение), %
      default: 20
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"
          mode: slider

    soft_mid_brightness:
      name: Средняя яркость (мягкое пробуждение), %
      default: 40
      selector:
        number:
          min: 10
          max: 80
          unit_of_measurement: "%"
          mode: slider

    soft_final_brightness:
      name: Итоговая яркость (мягкое пробуждение), %
      default: 100
      selector:
        number:
          min: 30
          max: 100
          unit_of_measurement: "%"
          mode: slider

    soft_step_delay:
      name: Пауза между шагами (мягкое пробуждение), мин
      default: 1
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: "мин"
          mode: slider

    # --- Вечер: опускание штор ---
    close_blinds_use_sun:
      name: Опускать шторы по солнцу
      description: >
        Если включено — закрываем шторы по "солнцу" (сенсор ниже).
        Если выключено — по фиксированному времени.
      default: true
      selector:
        boolean:

    blinds_fixed_time:
      name: Время опускания штор (фиксированное)
      description: >
        Используется, если опция "опускать по солнцу" выключена.
      default: "20:00:00"
      selector:
        time:

    sun_time_sensor:
      name: Сенсор времени заката/закрытия штор
      description: >
        Любой sensor, от которого нужно закрывать шторы.
      default: ""
      selector:
        entity:
          domain: sensor

mode: restart
max_exceeded: silent

variables:
  v_weekday_time: !input weekday_time
  v_weekend_time: !input weekend_time

  v_weekday_soft_mode: !input weekday_soft_mode
  v_weekend_soft_mode: !input weekend_soft_mode

  v_use_light: !input use_light
  v_use_blinds: !input use_blinds
  v_blinds_first: !input blinds_first
  v_delay_between: !input delay_between_blinds_and_light

  v_light: !input bedroom_light
  v_cover: !input bedroom_cover
  v_switch: !input bedroom_switch

  v_soft_start_brightness: !input soft_start_brightness
  v_soft_mid_brightness: !input soft_mid_brightness
  v_soft_final_brightness: !input soft_final_brightness
  v_soft_step_delay: !input soft_step_delay

  v_close_blinds_use_sun: !input close_blinds_use_sun
  v_blinds_fixed_time: !input blinds_fixed_time
  v_sun_time_sensor: !input sun_time_sensor

trigger:
  # Будильник: будни
  - id: weekday_alarm
    platform: time
    at: !input weekday_time

  # Будильник: выходные
  - id: weekend_alarm
    platform: time
    at: !input weekend_time

  # Опускание штор по фиксированному времени
  - id: blinds_close_fixed
    platform: time
    at: !input blinds_fixed_time

  # Опускание штор по "солнцу" (по выбранному сенсору)
  - id: blinds_close_sun
    platform: state
    entity_id: !input sun_time_sensor

condition: []

action:
  - choose:
      # -------------------------
      # 1. Будильник: будние дни
      # -------------------------
      - conditions:
          - condition: trigger
            id: weekday_alarm
          - condition: time
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
        sequence:
          - choose:
              # Мягкое пробуждение (будни)
              - conditions:
                  - condition: template
                    value_template: "{{ v_weekday_soft_mode }}"
                sequence:
                  - alias: "Мягкое пробуждение (будни)"
                    sequence:
                      # если и свет, и шторы включены
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ v_use_light and v_use_blinds }}"
                            sequence:
                              # вариант: сначала шторы, потом свет
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ v_blinds_first }}"
                                    sequence:
                                      # ШТОРЫ
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                                      # ЗАДЕРЖКА
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      # СВЕТ (мягкий)
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_start_brightness | int }}"
                                          transition: 30
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_mid_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_final_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                  # вариант: сначала свет, потом шторы
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ not v_blinds_first }}"
                                    sequence:
                                      # СВЕТ (мягкий)
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_start_brightness | int }}"
                                          transition: 30
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_mid_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_final_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                      # ЗАДЕРЖКА
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      # ШТОРЫ
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                        default:
                          # если только свет
                          - if:
                              - condition: template
                                value_template: "{{ v_use_light and not v_use_blinds }}"
                            then:
                              - if:
                                  - condition: template
                                    value_template: "{{ v_switch != '' }}"
                                then:
                                  - service: switch.turn_on
                                    target:
                                      entity_id: "{{ v_switch }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: "{{ v_soft_start_brightness | int }}"
                                  transition: 30
                              - delay:
                                  minutes: "{{ v_soft_step_delay | int }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: "{{ v_soft_mid_brightness | int }}"
                                  transition: "{{ (v_soft_step_delay | int) * 60 }}"
                              - delay:
                                  minutes: "{{ v_soft_step_delay | int }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: "{{ v_soft_final_brightness | int }}"
                                  transition: "{{ (v_soft_step_delay | int) * 60 }}"
                          # если только шторы
                          - if:
                              - condition: template
                                value_template: "{{ v_use_blinds and not v_use_light }}"
                            then:
                              - service: cover.open_cover
                                target:
                                  entity_id: "{{ v_cover }}"

              # Быстрое пробуждение (будни)
              - conditions:
                  - condition: template
                    value_template: "{{ not v_weekday_soft_mode }}"
                sequence:
                  - alias: "Быстрое пробуждение (будни)"
                    sequence:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ v_use_light and v_use_blinds }}"
                            sequence:
                              # сначала/потом по тому же флагу blinds_first
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ v_blinds_first }}"
                                    sequence:
                                      # ШТОРЫ
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      # СВЕТ (быстрый)
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: 80
                                          transition: 10
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ not v_blinds_first }}"
                                    sequence:
                                      # СВЕТ (быстрый)
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: 80
                                          transition: 10
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      # ШТОРЫ
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                        default:
                          # только свет
                          - if:
                              - condition: template
                                value_template: "{{ v_use_light and not v_use_blinds }}"
                            then:
                              - if:
                                  - condition: template
                                    value_template: "{{ v_switch != '' }}"
                                then:
                                  - service: switch.turn_on
                                    target:
                                      entity_id: "{{ v_switch }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: 80
                                  transition: 10
                          # только шторы
                          - if:
                              - condition: template
                                value_template: "{{ v_use_blinds and not v_use_light }}"
                            then:
                              - service: cover.open_cover
                                target:
                                  entity_id: "{{ v_cover }}"
            default: []

      # -------------------------
      # 2. Будильник: выходные
      # -------------------------
      - conditions:
          - condition: trigger
            id: weekend_alarm
          - condition: time
            weekday:
              - sat
              - sun
        sequence:
          - choose:
              # Мягкое пробуждение (выходные)
              - conditions:
                  - condition: template
                    value_template: "{{ v_weekend_soft_mode }}"
                sequence:
                  - alias: "Мягкое пробуждение (выходные)"
                    sequence:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ v_use_light and v_use_blinds }}"
                            sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ v_blinds_first }}"
                                    sequence:
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_start_brightness | int }}"
                                          transition: 30
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_mid_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_final_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ not v_blinds_first }}"
                                    sequence:
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_start_brightness | int }}"
                                          transition: 30
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_mid_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                      - delay:
                                          minutes: "{{ v_soft_step_delay | int }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: "{{ v_soft_final_brightness | int }}"
                                          transition: "{{ (v_soft_step_delay | int) * 60 }}"
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                        default:
                          - if:
                              - condition: template
                                value_template: "{{ v_use_light and not v_use_blinds }}"
                            then:
                              - if:
                                  - condition: template
                                    value_template: "{{ v_switch != '' }}"
                                then:
                                  - service: switch.turn_on
                                    target:
                                      entity_id: "{{ v_switch }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: "{{ v_soft_start_brightness | int }}"
                                  transition: 30
                              - delay:
                                  minutes: "{{ v_soft_step_delay | int }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: "{{ v_soft_mid_brightness | int }}"
                                  transition: "{{ (v_soft_step_delay | int) * 60 }}"
                              - delay:
                                  minutes: "{{ v_soft_step_delay | int }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: "{{ v_soft_final_brightness | int }}"
                                  transition: "{{ (v_soft_step_delay | int) * 60 }}"
                          - if:
                              - condition: template
                                value_template: "{{ v_use_blinds and not v_use_light }}"
                            then:
                              - service: cover.open_cover
                                target:
                                  entity_id: "{{ v_cover }}"

              # Быстрое пробуждение (выходные)
              - conditions:
                  - condition: template
                    value_template: "{{ not v_weekend_soft_mode }}"
                sequence:
                  - alias: "Быстрое пробуждение (выходные)"
                    sequence:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ v_use_light and v_use_blinds }}"
                            sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ v_blinds_first }}"
                                    sequence:
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: 80
                                          transition: 10
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ not v_blinds_first }}"
                                    sequence:
                                      - if:
                                          - condition: template
                                            value_template: "{{ v_switch != '' }}"
                                        then:
                                          - service: switch.turn_on
                                            target:
                                              entity_id: "{{ v_switch }}"
                                      - service: light.turn_on
                                        target:
                                          entity_id: "{{ v_light }}"
                                        data:
                                          brightness_pct: 80
                                          transition: 10
                                      - delay:
                                          seconds: "{{ v_delay_between | int }}"
                                      - service: cover.open_cover
                                        target:
                                          entity_id: "{{ v_cover }}"
                        default:
                          - if:
                              - condition: template
                                value_template: "{{ v_use_light and not v_use_blinds }}"
                            then:
                              - if:
                                  - condition: template
                                    value_template: "{{ v_switch != '' }}"
                                then:
                                  - service: switch.turn_on
                                    target:
                                      entity_id: "{{ v_switch }}"
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ v_light }}"
                                data:
                                  brightness_pct: 80
                                  transition: 10
                          - if:
                              - condition: template
                                value_template: "{{ v_use_blinds and not v_use_light }}"
                            then:
                              - service: cover.open_cover
                                target:
                                  entity_id: "{{ v_cover }}"
            default: []

      # -------------------------
      # 3. Опускание штор по фиксированному времени
      # -------------------------
      - conditions:
          - condition: trigger
            id: blinds_close_fixed
          - condition: template
            value_template: "{{ not v_close_blinds_use_sun }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ v_use_blinds }}"
            then:
              - service: cover.close_cover
                target:
                  entity_id: "{{ v_cover }}"

      # -------------------------
      # 4. Опускание штор по "солнцу"
      # -------------------------
      - conditions:
          - condition: trigger
            id: blinds_close_sun
          - condition: template
            value_template: "{{ v_close_blinds_use_sun }}"
          # при необходимости можно ограничить по конкретному состоянию сенсора:
          # - condition: state
          #   entity_id: !input sun_time_sensor
          #   state: "on"
        sequence:
          - if:
              - condition: template
                value_template: "{{ v_use_blinds }}"
            then:
              - service: cover.close_cover
                target:
                  entity_id: "{{ v_cover }}"
    default: []
