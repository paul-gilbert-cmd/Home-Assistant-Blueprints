blueprint:
  name: ZHA - TS004F Rotary Controller (multi-target, min 1%)
  description: |
    Управление яркостью света по событиям ZHA от ротари-контроллера:
    - Поворот по часовой стрелке/против (cluster 0x0008, command: step, step_mode 0/1): относительное изменение яркости с чувствительностью.
    - Одинарное нажатие (cluster 0x0006, command: toggle): установка точной яркости (с минимумом 1%).
    - Двойное нажатие: определяется как два toggle подряд с задержкой (установка другой точной яркости).
    Поддержка выбора нескольких целевых светильников (entity, группы, устройства, зоны).

  domain: automation

  input:
    controller:
      name: Контроллер ZHA
      description: Выберите устройство ZHA (ротари контроллер)
      selector:
        device:
          integration: zha
          multiple: false

    target_lights:
      name: Целевые светильники (несколько допускается)
      description: Выберите один или несколько источников света, группу, устройство или зону
      selector:
        target:
          entity:
            - domain: light

    sensitivity:
      name: Чувствительность поворота
      description: Множитель изменения яркости (шаг * множитель)
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 2.0
          step: 0.1
          mode: slider

    single_press_brightness:
      name: Яркость одинарного нажатия (%)
      description: Точное значение яркости при одиночном клике (минимум 1%)
      default: 50
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    double_press_brightness:
      name: Яркость двойного нажатия (%)
      description: Точное значение яркости при двойном клике (минимум 1%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    double_press_delay:
      name: Интервал двойного клика (мс)
      description: Максимальная пауза между двумя toggle
      default: 600
      selector:
        number:
          min: 200
          max: 1200
          step: 50
          unit_of_measurement: "ms"
          mode: slider

    smooth_transition:
      name: Плавные переходы
      description: Включить плавные переходы яркости
      default: true
      selector:
        boolean:

mode: parallel
max_exceeded: silent

variables:
  sensitivity: !input sensitivity
  single_bright_raw: !input single_press_brightness
  double_bright_raw: !input double_press_brightness
  dbl_delay: !input double_press_delay
  smooth: !input smooth_transition
  target_all: !input target_lights

  # Минимум 1% для точных установок
  single_bright: "{{ [single_bright_raw | int, 1] | max }}"
  double_bright: "{{ [double_bright_raw | int, 1] | max }}"
  trans_step: "{{ 0.3 if smooth else 0 }}"
  trans_press: "{{ 0.5 if smooth else 0 }}"

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input controller

action:
  - variables:
      command: "{{ trigger.event.data.command }}"
      cluster_id: "{{ trigger.event.data.cluster_id | int }}"
      step_mode: "{{ trigger.event.data.params.step_mode | default(-1) | int }}"
      step_size: "{{ trigger.event.data.params.step_size | default(0) | int }}"

  - choose:
      # Вращение по часовой стрелке (increase)
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 0 }}"
        sequence:
          # Предварительно включаем свет, чтобы исключить выключение при отрицательных шагах
          - service: light.turn_on
            target: !input target_lights
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_step_pct: "{{ (step_size * sensitivity) | int }}"
              transition: "{{ trans_step }}"

      # Вращение против часовой стрелки (decrease)
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 1 }}"
        sequence:
          - service: light.turn_on
            target: !input target_lights
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_step_pct: "{{ -(step_size * sensitivity) | int }}"
              transition: "{{ trans_step }}"

      # Нажатие (одинарное или двойное)
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' and cluster_id == 6 }}"
        sequence:
          - wait_for_trigger:
              - platform: event
                event_type: zha_event
                event_data:
                  device_id: !input controller
                  cluster_id: 6
                  command: toggle
            timeout:
              milliseconds: "{{ dbl_delay }}"
            continue_on_timeout: true

          - choose:
              # Двойной клик — пришло второе событие toggle в интервале
              - conditions:
                  - condition: template
                    value_template: "{{ wait.trigger is not none }}"
                sequence:
                  - service: light.turn_on
                    target: !input target_lights
                    data:
                      brightness_pct: "{{ double_bright }}"
                      transition: "{{ trans_press }}"

            # Одинарный клик — второго события не было
            default:
              - service: light.turn_on
                target: !input target_lights
                data:
                  brightness_pct: "{{ single_bright }}"
                  transition: "{{ trans_press }}"
