blueprint:
  name: DROZD TS004F Rotary Controller
  description: >
    Линейная регулировка яркости с настраиваемой чувствительностью,
    множественные цели (lights), распознавание двойного нажатия и возможность задать
    отдельный уровень яркости (в процентах) для одиночного и двойного нажатия.
  domain: automation
  input:
    zha_device:
      name: ZHA device
      description: "Выберите устройство ZHA (сравнение по device_id). Если не указано — автоматизация реагирует на все устройства."
      selector:
        device:
          integration: zha

    target_lights:
      name: Целевые устройства (можно выбрать несколько)
      selector:
        entity:
          domain: light
          multiple: true

    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0
          max: 10
          step: 0.1

    brightness_multiplier:
      name: Множитель дельты яркости
      description: "Умножает влияние step_size. Увеличьте для более резкого отклика."
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 10
          step: 0.1

    sensitivity_divisor:
      name: Чувствительность (делитель)
      description: "Делит (step_size * multiplier). Чем больше — тем мягче изменение. По умолчанию 4."
      default: 4.0
      selector:
        number:
          min: 0.1
          max: 20
          step: 0.1

    min_brightness:
      name: Минимальная яркость (0 = разрешать выключение)
      default: 1
      selector:
        number:
          min: 0
          max: 254
          step: 1

    # single-press action
    button_action:
      name: Одиночное нажатие
      description: "Действие при событии toggle (одиночное нажатие)."
      default: no_action
      selector:
        select:
          options:
            - brightness_1
            - brightness_100
            - brightness_custom
            - no_action

    # brightness value for single press (percent)
    single_press_brightness:
      name: Яркость при одиночном нажатии (%)
      description: "Используется, если выбрано brightness_custom. Значение 0 = выключить."
      default: 100
      selector:
        number:
          min: 0
          max: 100
          step: 1

    # double-press action
    double_button_action:
      name: Двойное нажатие
      description: "Действие, выполняемое при быстром двойном нажатии (время задаётся ниже)."
      default: no_action
      selector:
        select:
          options:
            - brightness_1
            - brightness_100
            - brightness_custom
            - no_action

    # brightness value for double press (percent)
    double_press_brightness:
      name: Яркость при двойном нажатии (%)
      description: "Используется, если выбрано brightness_custom для двойного нажатия. 0 = выключить."
      default: 100
      selector:
        number:
          min: 0
          max: 100
          step: 1

    double_press_timeout:
      name: Таймаут для распознавания двойного нажатия (секунды)
      description: "Ожидание второго toggle-события для распознавания двойного нажатия."
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 2
          step: 0.1

variables:
  # inputs
  zha_device_input: !input zha_device
  target_list: !input target_lights
  transition_speed: !input transition_speed
  brightness_multiplier: !input brightness_multiplier
  sensitivity_divisor: !input sensitivity_divisor
  min_brightness: !input min_brightness
  button_action: !input button_action
  double_button_action: !input double_button_action
  double_press_timeout: !input double_press_timeout
  single_press_brightness_pct: !input single_press_brightness
  double_press_brightness_pct: !input double_press_brightness

  # fields from event (safe parsing)
  cluster_id: "{{ trigger.event.data.cluster_id | int }}"
  command: "{{ trigger.event.data.command }}"
  device_id_from_event: "{{ trigger.event.data.device_id | default('') }}"

  # step_mode: params.step_mode OR args[0] OR 0
  step_mode: >
    {% set _sm = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_mode is not none %}
      {% set _sm = trigger.event.data.params.step_mode %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 0 %}
      {% set _sm = trigger.event.data.args[0] %}
    {% endif %}
    {{ _sm | int }}

  # step_size: params.step_size OR args[1] OR 0
  step_size: >
    {% set _ss = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_size is not none %}
      {% set _ss = trigger.event.data.params.step_size %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 1 %}
      {% set _ss = trigger.event.data.args[1] %}
    {% endif %}
    {{ _ss | int }}

  # first target to read brightness
  first_target: >
    {% if target_list is iterable and (target_list | length) > 0 %}
      {{ target_list[0] }}
    {% else %}
      {{ '' }}
    {% endif %}

  current_brightness: >
    {% set ft = (target_list[0] if (target_list is iterable and (target_list | length) > 0) else '') %}
    {{ (state_attr(ft, 'brightness') | default(0)) | int }}

  # compute delta: floor((step_size * multiplier) / sensitivity_divisor), min 1
  delta: >
    {% set raw = (step_size | int) * (brightness_multiplier | float) / (sensitivity_divisor | float) %}
    {% if (raw | int) < 1 %}
      1
    {% else %}
      {{ raw | int }}
    {% endif %}

trigger:
  - platform: event
    event_type: zha_event

condition:
  # if zha_device selected — filter by device_id, else allow all
  - condition: template
    value_template: >
      {% if zha_device_input | default('') != '' %}
        {{ (trigger.event.data.device_id | default('')) == zha_device_input }}
      {% else %}
        true
      {% endif %}
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      # Button press with double-press detection
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' }}"
        sequence:
          - variables:
              _dev_id: "{{ device_id_from_event }}"
          - wait_for_trigger:
              - platform: event
                event_type: zha_event
                event_data:
                  device_id: "{{ _dev_id }}"
                  command: "toggle"
            timeout: "00:00:{{ double_press_timeout }}"
            continue_on_timeout: true
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ wait.trigger is defined }}"
                sequence:
                  - variables:
                      _dbl_brightness: "{{ ((double_press_brightness_pct | float) / 100.0 * 255) | int }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ double_button_action == 'brightness_1' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: !input target_lights
                            data:
                              brightness: 1
                              transition: "{{ transition_speed }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ double_button_action == 'brightness_100' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: !input target_lights
                            data:
                              brightness: 255
                              transition: "{{ transition_speed }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ double_button_action == 'brightness_custom' }}"
                        sequence:
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ _dbl_brightness == 0 }}"
                                sequence:
                                  - service: light.turn_off
                                    target:
                                      entity_id: !input target_lights
                                    data:
                                      transition: "{{ transition_speed }}"
                              - default:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input target_lights
                                    data:
                                      brightness: "{{ _dbl_brightness }}"
                                      transition: "{{ transition_speed }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ double_button_action == 'no_action' }}"
                        sequence:
                          - variables:
                              _debug: "no double-action"
              - default:
                  - variables:
                      _single_brightness: "{{ ((single_press_brightness_pct | float) / 100.0 * 255) | int }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ button_action == 'brightness_1' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: !input target_lights
                            data:
                              brightness: 1
                              transition: "{{ transition_speed }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ button_action == 'brightness_100' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: !input target_lights
                            data:
                              brightness: 255
                              transition: "{{ transition_speed }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ button_action == 'brightness_custom' }}"
                        sequence:
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ _single_brightness == 0 }}"
                                sequence:
                                  - service: light.turn_off
                                    target:
                                      entity_id: !input target_lights
                                    data:
                                      transition: "{{ transition_speed }}"
                              - default:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input target_lights
                                    data:
                                      brightness: "{{ _single_brightness }}"
                                      transition: "{{ transition_speed }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ button_action == 'no_action' }}"
                        sequence:
                          - variables:
                              _debug: "no single-action"

      # Rotation -> linear change
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 }}"
        sequence:
          - variables:
              raw_new: >
                {% set cb = current_brightness | int %}
                {% set d = delta | int %}
                {% if step_mode | int == 1 %}
                  {{ cb - d }}
                {% else %}
                  {{ cb + d }}
                {% endif %}
              intended: >
                {% set nb = raw_new | int %}
                {% if nb < 0 %}
                  0
                {% elif nb > 255 %}
                  255
                {% else %}
                  {{ nb }}
                {% endif %}
              # final: if intended == 0 -> allow off only when min_brightness == 0,
              # otherwise ensure at least min_brightness; and if 0 < intended < min_brightness -> set to min_brightness
              final_brightness: >
                {% set ib = (min_brightness | int) %}
                {% if intended == 0 %}
                  {% if ib == 0 %}
                    0
                  {% else %}
                    {{ ib }}
                  {% endif %}
                {% else %}
                  {% if ib > 0 and intended < ib %}
                    {{ ib }}
                  {% else %}
                    {{ intended }}
                  {% endif %}
                {% endif %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ final_brightness == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ final_brightness > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ final_brightness }}"
                      transition: "{{ transition_speed }}"
