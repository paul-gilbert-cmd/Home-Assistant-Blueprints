blueprint:
  name: ZHA - TS004F Rotary Controller
  description: |
    Управление яркостью света с помощью поворотного контроллера TS004F через ZHA. 
    
    Функции:
    - Поворот по часовой стрелке: увеличение яркости
    - Поворот против часовой стрелки: уменьшение яркости
    - Одинарное нажатие: установка заданной яркости
    - Двойное нажатие: установка другой заданной яркости
    - Настраиваемая чувствительность поворота
    
  domain: automation
  
  input:
    controller:
      name: Контроллер TS004F
      description: Выберите устройство TS004F Rotary Controller (или любое ZHA устройство)
      selector:
        device:
          integration: zha
          multiple: false
    
    target_light:
      name: Управляемое устройство освещения
      description: Выберите светильник или группу светильников для управления
      selector:
        target:
          entity:
            - domain: light
    
    sensitivity:
      name: Чувствительность поворота
      description: Множитель для изменения яркости при повороте (чем выше, тем больше изменение)
      default: 2. 0
      selector:
        number:
          min: 0. 5
          max: 5. 0
          step: 0. 5
          mode: slider
    
    single_press_brightness:
      name: Яркость при одинарном нажатии
      description: Яркость в процентах при одинарном нажатии кнопки
      default: 50
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
    
    double_press_brightness:
      name: Яркость при двойном нажатии
      description: Яркость в процентах при двойном нажатии кнопки
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
    
    smooth_transition:
      name: Плавный переход
      description: Включить плавное изменение яркости
      default: true
      selector:
        boolean:

mode: restart
max_exceeded: silent

variables:
  sensitivity_var: ! input sensitivity
  single_brightness: !input single_press_brightness
  double_brightness: !input double_press_brightness
  smooth: !input smooth_transition

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input controller

action:
  - variables:
      command: "{{ trigger.event.data.command }}"
      cluster_id: "{{ trigger. event.data.cluster_id }}"
      step_mode: "{{ trigger.event.data.params.step_mode | default(none) }}"
      step_size: "{{ trigger.event.data.params.step_size | default(0) }}"
      
  - choose:
      # Поворот по часовой стрелке (увеличение яркости)
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 0 }}"
        sequence:
          - service: light.turn_on
            target: !input target_light
            data:
              brightness_step_pct: >
                {{ (step_size * sensitivity_var) | int }}
              transition: >
                {{ 0.3 if smooth else 0 }}
      
      # Поворот против часовой стрелки (уменьшение яркости)
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 1 }}"
        sequence:
          - service: light. turn_on
            target: ! input target_light
            data:
              brightness_step_pct: >
                {{ -(step_size * sensitivity_var) | int }}
              transition: >
                {{ 0.3 if smooth else 0 }}
      
      # Одинарное нажатие (toggle или включение с заданной яркостью)
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' and cluster_id == 6 }}"
        sequence:
          - choose:
              # Если свет выключен, включаем с заданной яркостью
              - conditions:
                  - condition: template
                    value_template: >
                      {% set lights = namespace(off=true) %}
                      {% if target_light.entity_id is defined %}
                        {% set lights. off = is_state(target_light.entity_id, 'off') %}
                      {% else %}
                        {% set lights. off = false %}
                      {% endif %}
                      {{ lights. off }}
                sequence:
                  - service: light.turn_on
                    target: !input target_light
                    data:
                      brightness_pct: ! input single_press_brightness
                      transition: >
                        {{ 0.5 if smooth else 0 }}
            default:
              # Если свет включен, устанавливаем заданную яркость
              - service: light.turn_on
                target: !input target_light
                data:
                  brightness_pct: !input single_press_brightness
                  transition: >
                    {{ 0.5 if smooth else 0 }}
      
      # Двойное нажатие (on command)
      - conditions:
          - condition: template
            value_template: "{{ command == 'on' and cluster_id == 6 }}"
        sequence:
          - service: light.turn_on
            target: !input target_light
            data:
              brightness_pct: !input double_press_brightness
              transition: >
                {{ 0.5 if smooth else 0 }}
      
      # Команда выключения (если есть)
      - conditions:
          - condition: template
            value_template: "{{ command == 'off' and cluster_id == 6 }}"
        sequence:
          - service: light.turn_off
            target: !input target_light
            data:
              transition: >
                {{ 0. 5 if smooth else 0 }}
