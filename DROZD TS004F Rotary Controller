blueprint:
  name: TS004F Rotary Controller
  description: Универсальная автоматизация для поворотного контроллера Xiaomi/Aqara TS004F
  domain: automation
  input:
    device_ieee:
      name: IEEE адрес TS004F
      description: "Введи IEEE адрес (например: a4:c1:38:aa:56:c4:e8:76)"
      selector:
        text:
    
    target_light:
      name: Целевое устройство
      selector:
        entity:
          domain: light
    
    brightness_presets:
      name: Целевые уровни яркости
      default: [51, 102, 153, 204, 255]
      selector:
        object:
    
    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0
          max: 5
          step: 0.1

variables:
  device_ieee_input: !input device_ieee
  cluster_id: "{{ trigger.event.data.cluster_id }}"
  command: "{{ trigger.event.data.command }}"
  step_mode: "{{ trigger.event.data.params.get('step_mode') }}"
  step_size: "{{ trigger.event.data.args[1] if trigger.event.data.args | length > 1 else 0 }}"
  current_brightness: "{{ state_attr(input.target_light, 'brightness') | default(0) | int }}"
  presets: "{{ input.brightness_presets | default([51, 102, 153, 204, 255]) }}"
  
  current_index: >
    {%- set closest = 0 -%}
    {%- for i in range(presets | length) -%}
      {%- if (presets[i] - current_brightness) | abs < (presets[closest] - current_brightness) | abs -%}
        {%- set closest = i -%}
      {%- endif -%}
    {%- endfor -%}
    {{ closest }}
  
  is_fast: "{{ step_size > 20 }}"
  is_ccw: "{{ step_mode == 1 }}"

trigger:
  - platform: event
    event_type: zha_event

condition:
  - condition: template
    value_template: "{{ trigger.event.data.device_ieee == device_ieee_input }}"
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' }}"
        sequence:
          - service: light.toggle
            target:
              entity_id: !input target_light
      
      - conditions:
          - condition: template
            value_template: "{{ not is_ccw }}"
        sequence:
          - variables:
              new_idx: "{{ [current_index + (2 if is_fast else 1), presets | length - 1] | min }}"
              brightness_value: "{{ presets[new_idx] }}"
          - service: light.turn_on
            target:
              entity_id: !input target_light
            
              brightness: "{{ brightness_value }}"
              transition: !input transition_speed
      
      - conditions:
          - condition: template
            value_template: "{{ is_ccw }}"
        sequence:
          - variables:
              new_idx: "{{ [current_index - (2 if is_fast else 1), 0] | max }}"
              brightness_value: "{{ presets[new_idx] }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_light
                    
                      brightness: "{{ brightness_value }}"
                      transition: !input transition_speed
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_light
                    
                      transition: !input transition_speed
