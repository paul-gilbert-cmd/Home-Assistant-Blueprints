blueprint:
  name: DROZD TS004F Rotary Controller (stable single-press)
  description: 'Линейная регулировка яркости с настраиваемой чувствительностью, множественные цели (lights).
    Простая и надёжная обработка одиночного нажатия (без распознавания двойного нажатия).
    Импортируйте этот blueprint, создайте автоматику из него и протестируйте кнопку.'
  domain: automation
  input:
    zha_device:
      name: ZHA device
      description: "Выберите устройство ZHA (сравнение по device_id). Если не указано — автоматизация реагирует на все устройства."
      selector:
        device:
          integration: zha

    target_lights:
      name: Целевые устройства (можно выбрать несколько)
      selector:
        entity:
          domain:
          - light
          multiple: true

    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0.0
          max: 10.0
          step: 0.1

    brightness_multiplier:
      name: Множитель дельты яркости
      description: "Умножает влияние step_size. Увеличьте для более резкого отклика."
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 10.0
          step: 0.1

    sensitivity_divisor:
      name: Чувствительность (делитель)
      description: "Делит (step_size * multiplier). Чем больше — тем мягче изменение."
      default: 4.0
      selector:
        number:
          min: 0.1
          max: 20.0
          step: 0.1

    min_brightness:
      name: Минимальная яркость (0 = разрешать выключение)
      default: 1
      selector:
        number:
          min: 0
          max: 254
          step: 1

    # single-press action
    button_action:
      name: Одиночное нажатие
      description: "Действие при событии toggle (одиночное нажатие)."
      default: no_action
      selector:
        select:
          options:
            - brightness_1
            - brightness_100
            - brightness_custom
            - no_action

    # brightness value for single press (percent)
    single_press_brightness:
      name: Яркость при одиночном нажатии (%)
      description: "Используется, если выбрано brightness_custom. Значение 0 = выключить."
      default: 100
      selector:
        number:
          min: 0
          max: 100
          step: 1

variables:
  zha_device_input: !input zha_device
  target_list: !input target_lights
  transition_speed: !input transition_speed
  brightness_multiplier: !input brightness_multiplier
  sensitivity_divisor: !input sensitivity_divisor
  min_brightness: !input min_brightness
  button_action: !input button_action
  single_press_brightness_pct: !input single_press_brightness

  # safe parsing of event fields
  cluster_id: "{{ trigger.event.data.cluster_id | int }}"
  command: "{{ trigger.event.data.command }}"
  device_id_from_event: "{{ trigger.event.data.device_id | default('') }}"

  # step_mode safe
  step_mode: >
    {% set _sm = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_mode is not none %}
      {% set _sm = trigger.event.data.params.step_mode %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 0 %}
      {% set _sm = trigger.event.data.args[0] %}
    {% endif %}
    {{ _sm | int }}

  # step_size safe
  step_size: >
    {% set _ss = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_size is not none %}
      {% set _ss = trigger.event.data.params.step_size %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 1 %}
      {% set _ss = trigger.event.data.args[1] %}
    {% endif %}
    {{ _ss | int }}

  # current brightness from first target (if any)
  first_target: >
    {% if target_list is iterable and (target_list | length) > 0 %}
      {{ target_list[0] }}
    {% else %}
      {{ '' }}
    {% endif %}

  current_brightness: >
    {% set ft = (target_list[0] if (target_list is iterable and (target_list | length) > 0) else '') %}
    {{ (state_attr(ft, 'brightness') | default(0)) | int }}

  # delta calculation
  delta: >
    {% set raw = (step_size | int) * (brightness_multiplier | float) / (sensitivity_divisor | float) %}
    {% if (raw | int) < 1 %}
      1
    {% else %}
      {{ raw | int }}
    {% endif %}

trigger:
  - platform: event
    event_type: zha_event

condition:
  - condition: template
    value_template: >
      {% if zha_device_input | default('') != '' %}
        {{ (trigger.event.data.device_id | default('')) == zha_device_input }}
      {% else %}
        true
      {% endif %}
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      # immediate handling of toggle (single press only)
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.data.command == 'toggle' }}"
        sequence:
          - variables:
              _b_pct: "{{ single_press_brightness_pct | float }}"
              _b_val: >
                {% set p = _b_pct %}
                {{ ((p / 100.0) * 255) | int }}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'brightness_1' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: 1
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'brightness_100' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: 255
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'brightness_custom' and _b_val == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'brightness_custom' and _b_val > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ _b_val }}"
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'no_action' }}"
                sequence:
                  - variables:
                      _debug: "no action"

      # rotation -> linear brightness change
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.data.command == 'step' and trigger.event.data.cluster_id | int == 8 }}"
        sequence:
          - variables:
              raw_new: >
                {% set cb = current_brightness | int %}
                {% set d = delta | int %}
                {% if step_mode | int == 1 %}
                  {{ cb - d }}
                {% else %}
                  {{ cb + d }}
                {% endif %}
              intended: >
                {% set nb = raw_new | int %}
                {% if nb < 0 %}
                  0
                {% elif nb > 255 %}
                  255
                {% else %}
                  {{ nb }}
                {% endif %}
              final_brightness: >
                {% set ib = (min_brightness | int) %}
                {% if intended == 0 %}
                  {% if ib == 0 %}
                    0
                  {% else %}
                    {{ ib }}
                  {% endif %}
                {% else %}
                  {% if ib > 0 and intended < ib %}
                    {{ ib }}
                  {% else %}
                    {{ intended }}
                  {% endif %}
                {% endif %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ final_brightness == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ final_brightness > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ final_brightness }}"
                      transition: "{{ transition_speed }}"
