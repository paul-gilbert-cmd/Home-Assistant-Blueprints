blueprint:
  name: DROZD ZHA - TS004F Rotary Controller "Dimmer" (rotation + single press, min 1% fixed)
  description: |
    Управление яркостью по событиям ZHA от TS004F:
      - Вращение (cluster 0x0008, command: step, step_mode 0/1): плавное увеличение / уменьшение яркости.
        Для отдельных сущностей используется точный пересчёт уровня (0–255) с порогом ≥1% (уровень 3).
        Для групп/зон (fallback) применяются ограниченные процентные шаги с защитой от ухода в 0%.
      - Одиночный клик (cluster 0x0006, command: toggle): установка пресета single_bright (≥1%).
    Минимальная яркость никогда не опускается ниже ~1%. Поддержка нескольких светильников.

  domain: automation

  input:
    controller:
      name: Устройства ZHA
      description: |
        Выберите свой TS004F
      selector:
        device:
          integration: zha
          multiple: false

    target_lights:
      name: Целевые светильники
      description: |
        Выберите сущность
      selector:
        target:
          entity:
            - domain: light

    sensitivity:
      name: Чувствительность вращения
      description: |
        
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 2.0
          step: 0.1
          mode: slider

    max_delta_level:
      name: Максимальный шаг (уровни 0–255)
      description: |
        Ограничивает слишком большие скачки при быстром вращении.
      default: 40
      selector:
        number:
          min: 5
          max: 120
          step: 5
          mode: slider

    single_press_brightness:
      name: Яркость при одиночном нажатии
      description: |
        Минимум 1%.
      default: 1
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    rotation_transition:
      name: Плавность вращения (сек)
      description: |
        Время перехода при каждом step. 0 = мгновенно.
      default: 0
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          unit_of_measurement: "s"
          mode: slider

    press_transition:
      name: Переход при нажатии (сек)
      description: |
        Время плавного изменения яркости при toggle.
      default: 0
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "s"
          mode: slider

    enable_debug:
      name: Включить debug лог
      description: |
        Пишет события в system_log.write.
      default: false
      selector:
        boolean:

mode: parallel
max_exceeded: silent

variables:
  sensitivity: !input sensitivity
  max_delta: !input max_delta_level
  single_bright_raw: !input single_press_brightness
  single_bright: "{{ [single_bright_raw | int, 1] | max }}"
  rot_trans: !input rotation_transition
  press_trans: !input press_transition
  debug: !input enable_debug
  tgt: !input target_lights
  min_level: 3  # ≈1%

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input controller

action:
  - variables:
      command: "{{ trigger.event.data.command }}"
      cluster_id: "{{ trigger.event.data.cluster_id | int }}"
      step_mode: "{{ trigger.event.data.params.step_mode | default(-1) | int }}"
      step_size: "{{ trigger.event.data.params.step_size | default(0) | int }}"
      light_entities: >
        {% set res = [] %}
        {% if tgt.entity_id is defined %}
          {% set raw = tgt.entity_id %}
          {% set entities = raw if (raw is iterable and (raw is not string)) else [raw] %}
          {% for e in entities %}
            {% if e is string and e.startswith('light.') %}
              {% set res = res + [e] %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {{ res }}
      lights_count: "{{ light_entities | length }}"

  - choose:

      ######################################################################
      # Вращение + (step_mode 0)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 0 }}"
        sequence:
          - choose:
              # Пер-entity точный расчёт
              - conditions:
                  - condition: template
                    value_template: "{{ lights_count > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ light_entities }}"
                      sequence:
                        - variables:
                            entity_id: "{{ repeat.item }}"
                            current_level: >
                              {% set st = states(entity_id) %}
                              {% set bri = state_attr(entity_id,'brightness') %}
                              {% if st == 'off' %}
                                0
                              {% elif bri is number %}
                                {{ bri }}
                              {% else %}
                                255
                              {% endif %}
                            raw_delta: "{{ (step_size * sensitivity) | float }}"
                            clamped_delta: >
                              {% if raw_delta > max_delta %}{{ max_delta }}{% else %}{{ raw_delta }}{% endif %}
                            new_raw: "{{ current_level | float + clamped_delta }}"
                            new_hi: "{{ [new_raw,255] | min }}"
                            new_level: "{{ [new_hi,min_level] | max | round(0) }}"
                        - service: light.turn_on
                          target:
                            entity_id: "{{ entity_id }}"
                          data:
                            brightness: "{{ new_level }}"
                            transition: "{{ rot_trans }}"
            default:
              # Fallback для группы/зоны — безопасный шаг (не уходим в 0%)
              - variables:
                  pct_step_raw: "{{ (step_size / 254 * 100) * sensitivity }}"
                  pct_step: >
                    {% set v = pct_step_raw %}
                    {% if v > 40 %}40{% elif v < 1 %}1{% else %}{{ v | round(0) }}{% endif %}
                  any_off: >
                    {% set ents = tgt.entity_id if (tgt.entity_id is iterable and (tgt.entity_id is not string)) else [tgt.entity_id] %}
                    {% set off = false %}
                    {% for e in ents %}
                      {% if e is string and e.startswith('light.') and states(e) == 'off' %}
                        {% set off = true %}
                      {% endif %}
                    {% endfor %}
                    {{ off }}
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ any_off == 'True' or any_off == 'true' }}"
                    sequence:
                      - service: light.turn_on
                        target: !input target_lights
                        data:
                          brightness_pct: 1
                          transition: "{{ rot_trans }}"
              - service: light.turn_on
                target: !input target_lights
                data:
                  brightness_step_pct: "{{ pct_step }}"
                  transition: "{{ rot_trans }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: info
                      message: >
                        [Rotate +] step_size={{ step_size }} pct_step_raw={{ (step_size / 254 * 100) * sensitivity }}
                        lights_count={{ lights_count }}

      ######################################################################
      # Вращение - (step_mode 1)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 1 }}"
        sequence:
          - choose:
              # Пер-entity точный расчёт
              - conditions:
                  - condition: template
                    value_template: "{{ lights_count > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ light_entities }}"
                      sequence:
                        - variables:
                            entity_id: "{{ repeat.item }}"
                            current_level: >
                              {% set st = states(entity_id) %}
                              {% set bri = state_attr(entity_id,'brightness') %}
                              {% if st == 'off' %}
                                0
                              {% elif bri is number %}
                                {{ bri }}
                              {% else %}
                                255
                              {% endif %}
                            raw_delta: "{{ (step_size * sensitivity) | float }}"
                            clamped_delta: >
                              {% if raw_delta > max_delta %}{{ max_delta }}{% else %}{{ raw_delta }}{% endif %}
                            new_raw: "{{ current_level | float - clamped_delta }}"
                            above_min: "{{ new_raw if new_raw > min_level else min_level }}"
                            new_level: "{{ [above_min,255] | min | round(0) }}"
                        - service: light.turn_on
                          target:
                            entity_id: "{{ entity_id }}"
                          data:
                            brightness: "{{ new_level }}"
                            transition: "{{ rot_trans }}"
            default:
              # Fallback для группы/зоны — предотвращаем уход в 0%
              - variables:
                  pct_step_raw: "{{ (step_size / 254 * 100) * sensitivity }}"
                  pct_step: >
                    {% set v = pct_step_raw %}
                    {% if v > 40 %}40{% elif v < 1 %}1{% else %}{{ v | round(0) }}{% endif %}
                  ref_entity: >
                    {% if tgt.entity_id is defined %}
                      {% set raw = tgt.entity_id %}
                      {% set ents = raw if (raw is iterable and (raw is not string)) else [raw] %}
                      {% for e in ents %}
                        {% if e is string and e.startswith('light.') %}
                          {{ e }}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                    {% else %}None{% endif %}
                  current_pct: >
                    {% if ref_entity and states(ref_entity) != 'off' and (state_attr(ref_entity,'brightness') is number) %}
                      {{ (state_attr(ref_entity,'brightness') / 255 * 100) | round(0) }}
                    {% elif ref_entity and states(ref_entity) != 'off' %}
                      100
                    {% else %}
                      0
                    {% endif %}
                  new_pct: "{{ current_pct - pct_step }}"
                  need_min: "{{ new_pct < 1 }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ states(ref_entity) == 'off' or need_min }}"
                    sequence:
                      - service: light.turn_on
                        target: !input target_lights
                        data:
                          brightness_pct: 1
                          transition: "{{ rot_trans }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not (states(ref_entity) == 'off' or need_min) }}"
                    sequence:
                      - service: light.turn_on
                        target: !input target_lights
                        data:
                          brightness_step_pct: "{{ -(pct_step) }}"
                          transition: "{{ rot_trans }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: info
                      message: >
                        [Rotate -] step_size={{ step_size }} pct_step_raw={{ (step_size / 254 * 100) * sensitivity }}
                        lights_count={{ lights_count }}

      ######################################################################
      # Одиночный клик (toggle)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' and cluster_id == 6 }}"
        sequence:
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_pct: "{{ single_bright }}"
              transition: "{{ press_trans }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: info
                      message: >
                        [Single Press] brightness_pct={{ single_bright }}
