blueprint:
  name: DROZD TS004F Rotary Controller
  description: Универсальная автоматизация для поворотного контроллера Xiaomi/Aqara TS004F с выбором целевой яркости
  domain: automation
  input:
    device_ieee:
      name: IEEE
      description: "Введи точный IEEE адрес устройства"
      selector:
        text:
    
    target_light:
      name: Целевое устройство
      description: Лампа или группа ламп для управления яркостью
      selector:
        entity:
          domain: light
    
    brightness_presets:
      name: Целевые уровни яркости
      description: Список желаемых уровней яркости (0-255). По умолчанию 5 уровней
      default: [51, 102, 153, 204, 255]
      selector:
        object:
    
    transition_speed:
      name: Скорость переходов
      description: Время плавного перехода между уровнями (в секундах)
      default: 0.5
      selector:
        number:
          min: 0
          max: 5
          step: 0.1
          unit_of_measurement: "s"

variables:
  device_ieee_input: !input device_ieee
  cluster_id: "{{ trigger.event.data.cluster_id }}"
  command: "{{ trigger.event.data.command }}"
  step_mode: "{{ trigger.event.data.params.get('step_mode') }}"
  step_size: "{{ trigger.event.data.args[1] if trigger.event.data.args|length > 1 else 0 }}"
  
  current_brightness: "{{ state_attr(input.target_light, 'brightness') | default(0, true) | int }}"
  
  presets: "{{ input.brightness_presets | default([51, 102, 153, 204, 255]) }}"
  
  current_index: >
    {%- set ns = namespace(index=0) -%}
    {%- for preset in presets -%}
      {%- if (current_brightness - preset) | abs <= 25 -%}
        {%- set ns.index = loop.index0 -%}
      {%- endif -%}
    {%- endfor -%}
    {{ ns.index }}
  
  rotation_speed: >
    {%- if step_size < 15 -%}
      slow
    {%- elif step_size < 22 -%}
      medium
    {%- else -%}
      fast
    {%- endif -%}

trigger:
  - platform: event
    event_type: zha_event

condition:
  - condition: template
    value_template: "{{ trigger.event.data.device_ieee == device_ieee_input and cluster_id in [6, 8] }}"

action:
  - if:
      - condition: template
        value_template: "{{ command == 'toggle' }}"
    then:
      - service: light.toggle
        target:
          entity_id: !input target_light
        
          transition: "{{ input.transition_speed }}"
    
    else:
      - if:
          - condition: template
            value_template: "{{ step_mode is defined and step_mode == 0 }}"
        then:
          - variables:
              next_index: >
                {%- if rotation_speed == 'fast' -%}
                  {{ [current_index + 2, presets | length - 1] | min }}
                {%- else -%}
                  {{ [current_index + 1, presets | length -
