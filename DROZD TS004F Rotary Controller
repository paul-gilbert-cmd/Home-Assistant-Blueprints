blueprint:
  name: DROZD TS004F Rotary Controller
  description: Универсальная автоматизация для поворотного контроллера Xiaomi/Aqara TS004F
  domain: automation
  input:
    # Опциональный селектор ZHA-устройства (удобно выбирать устройство в UI)
    zha_device:
      name: Выберите устройство ZHA (опционально)
      description: "Можно выбрать ZHA-устройство. ВНИМАНИЕ: из-за ограничений blueprints автоматического извлечения IEEE не всегда происходит — см. пояснение ниже."
      selector:
        device:
          integration: zha

    device_ieee:
      name: IEEE адрес TS004F (например a4:c1:38:aa:56:c4:e8:76)
      description: "Если zha_device не помогает, вставьте сюда IEEE адрес (строкой)."
      selector:
        text:

    target_lights:
      name: Целевые устройства (можно выбрать несколько)
      selector:
        entity:
          domain: light
          multiple: true

    brightness_presets:
      name: Целевые уровни яркости
      default: [51, 102, 153, 204, 255]
      selector:
        object:

    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0
          max: 10
          step: 0.1

variables:
  # Если вы указали zha_device, оставляю поле для будущего автополучения IEEE.
  # На практике в UI часто удобнее скопировать IEEE из ZHA-устройства и вставить здесь.
  device_ieee_input: !input device_ieee

  # Приводим числовые поля к int, чтобы сравнения работали корректно
  cluster_id: "{{ trigger.event.data.cluster_id | int }}"
  command: "{{ trigger.event.data.command }}"
  step_mode: "{{ (trigger.event.data.params.get('step_mode') if trigger.event.data.params is defined else 0) | int }}"
  step_size: "{{ (trigger.event.data.args[1] if (trigger.event.data.args is defined and (trigger.event.data.args | length) > 1) else 0) | int }}"

  # Для многократного выбора целевых устройств берём первый для определения current_brightness
  target_list: !input target_lights
  first_target: "{{ (target_list[0] if (target_list is iterable and (target_list | length) > 0) else '') }}"

  current_brightness: "{{ (state_attr(first_target, 'brightness') | default(0) ) | int }}"
  presets: "{{ input.brightness_presets | default([51, 102, 153, 204, 255]) }}"

  current_index: >
    {%- set closest = 0 -%}
    {%- for i in range(presets | length) -%}
      {%- if (presets[i] - current_brightness) | abs < (presets[closest] - current_brightness) | abs -%}
        {%- set closest = i -%}
      {%- endif -%}
    {%- endfor -%}
    {{ closest }}

  is_fast: "{{ step_size > 20 }}"
  is_ccw: "{{ step_mode == 1 }}"

trigger:
  - platform: event
    event_type: zha_event

condition:
  # Логика допускает либо сравнение по введённому IEEE, либо (в будущем) по выбранному zha_device.
  - condition: template
    value_template: >
      {% if device_ieee_input | trim != '' %}
        {{ trigger.event.data.device_ieee == device_ieee_input }}
      {% else %}
        true
      {% endif %}
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' }}"
        sequence:
          - service: light.toggle
            target:
              entity_id: !input target_lights

      - conditions:
          - condition: template
            value_template: "{{ not is_ccw }}"
        sequence:
          - variables:
              new_idx: "{{ [current_index + (2 if is_fast else 1), presets | length - 1] | min }}"
              brightness_value: "{{ presets[new_idx] }}"
          - service: light.turn_on
            target:
              entity_id: !input target_lights
            data:
              brightness: "{{ brightness_value | int }}"
              transition: !input transition_speed

      - conditions:
          - condition: template
            value_template: "{{ is_ccw }}"
        sequence:
          - variables:
              new_idx: "{{ [current_index - (2 if is_fast else 1), 0] | max }}"
              brightness_value: "{{ presets[new_idx] }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value | int > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ brightness_value | int }}"
                      transition: !input transition_speed
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value | int == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: !input transition_speed
