blueprint:
  name: ZHA - TS004F Rotary Controller (long press activates second brightness)
  description: |
    Управление яркостью по ZHA событиям TS004F:
      - Вращение (cluster 0x0008, command: step, step_mode 0/1) — плавное изменение яркости с чувствительностью и порогом ≥1%.
      - Одиночный клик (cluster 0x0006, toggle) — установка яркости single_bright (≥1%).
      - Долгое нажатие (начинается по cluster 0x0008, command: move) — по отпусканию (stop) или по истечению тайм-аута устанавливается яркость double_bright (≥1%).
    Поддерживается выбор нескольких целевых светильников, каждая сущность обрабатывается индивидуально.

  domain: automation

  input:
    controller:
      name: Контроллер ZHA
      description: |
        Выберите устройство (ротари контроллер).
      selector:
        device:
          integration: zha
          multiple: false

    target_lights:
      name: Целевые светильники
      description: |
        Выберите один или несколько источников света / группу / устройство / зону.
      selector:
        target:
          entity:
            - domain: light

    sensitivity:
      name: Чувствительность вращения
      description: |
        Множитель шага. Итоговый прирост уровней (0–255) = step_size * sensitivity, обрезается max_delta_level.
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 2.0
          step: 0.1
          mode: slider

    max_delta_level:
      name: Максимальный шаг (уровни 0–255)
      description: |
        Ограничивает слишком большие скачки при быстром вращении.
      default: 40
      selector:
        number:
          min: 5
          max: 120
          step: 5
          mode: slider

    single_press_brightness:
      name: Яркость одиночного нажатия (%)
      description: |
        Точное значение яркости при одиночном клике. Минимум 1%.
      default: 50
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    double_press_brightness:
      name: Яркость при долгом нажатии (%)
      description: |
        Второй вариант яркости, активируется удержанием (move → stop/timeout). Минимум 1%.
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider

    hold_delay_ms:
      name: Время удержания (мс) до активации второго варианта яркости
      description: |
        Если отпускание (stop) произошло раньше — яркость применится сразу по stop. Если stop не пришел — по тайм-ауту.
      default: 600
      selector:
        number:
          min: 200
          max: 2000
          step: 50
          unit_of_measurement: "ms"
          mode: slider

    rotation_transition:
      name: Переход при вращении (сек)
      description: |
        Время плавного изменения при каждом шаге. 0 — максимально отзывчиво.
      default: 0
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          unit_of_measurement: "s"
          mode: slider

    press_transition:
      name: Переход при нажатии (сек)
      description: |
        Время плавного изменения яркости при одиночном/долгом нажатии.
      default: 0.3
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "s"
          mode: slider

    enable_debug:
      name: Включить debug лог
      description: |
        При включении пишутся сообщения в system_log.write.
      default: false
      selector:
        boolean:

mode: parallel
max_exceeded: silent

variables:
  sensitivity: !input sensitivity
  max_delta: !input max_delta_level
  single_bright_raw: !input single_press_brightness
  double_bright_raw: !input double_press_brightness
  single_bright: "{{ [single_bright_raw | int, 1] | max }}"
  double_bright: "{{ [double_bright_raw | int, 1] | max }}"
  rot_trans: !input rotation_transition
  press_trans: !input press_transition
  hold_ms: !input hold_delay_ms
  debug: !input enable_debug
  tgt: !input target_lights
  min_level: 3  # ~1% (255 * 0.01 ≈ 2.55)

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input controller

action:
  - variables:
      command: "{{ trigger.event.data.command }}"
      cluster_id: "{{ trigger.event.data.cluster_id | int }}"
      step_mode: "{{ trigger.event.data.params.step_mode | default(-1) | int }}"
      step_size: "{{ trigger.event.data.params.step_size | default(0) | int }}"
      # Извлекаем список light.* сущностей из target
      light_entities: >
        {% set res = [] %}
        {% if tgt.entity_id is defined %}
          {% set raw = tgt.entity_id %}
          {% set entities = raw if (raw is iterable and (raw is not string)) else [raw] %}
          {% for e in entities %}
            {% if e is string and e.startswith('light.') %}
              {% set res = res + [e] %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {{ res }}
      lights_count: "{{ light_entities | length }}"

  - choose:
      ######################################################################
      # Вращение по часовой стрелке (увеличение яркости)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 0 }}"
        sequence:
          - repeat:
              for_each: "{{ light_entities }}"
              sequence:
                - variables:
                    entity_id: "{{ repeat.item }}"
                    current_level: >
                      {% set st = states(entity_id) %}
                      {% set bri = state_attr(entity_id, 'brightness') %}
                      {% if st == 'off' %}
                        0
                      {% elif bri is number %}
                        {{ bri }}
                      {% else %}
                        255
                      {% endif %}
                    raw_delta: "{{ (step_size * sensitivity) | float }}"
                    clamped_delta: >
                      {% if raw_delta > max_delta %}{{ max_delta }}{% else %}{{ raw_delta }}{% endif %}
                    new_raw: "{{ current_level | float + clamped_delta }}"
                    new_hi: "{{ [new_raw, 255] | min }}"
                    new_level: "{{ [new_hi, min_level] | max | round(0) }}"
                - service: light.turn_on
                  target:
                    entity_id: "{{ entity_id }}"
                  data:
                    brightness: "{{ new_level }}"
                    transition: "{{ rot_trans }}"

      ######################################################################
      # Вращение против часовой стрелки (уменьшение яркости)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 and step_mode == 1 }}"
        sequence:
          - repeat:
              for_each: "{{ light_entities }}"
              sequence:
                - variables:
                    entity_id: "{{ repeat.item }}"
                    current_level: >
                      {% set st = states(entity_id) %}
                      {% set bri = state_attr(entity_id, 'brightness') %}
                      {% if st == 'off' %}
                        0
                      {% elif bri is number %}
                        {{ bri }}
                      {% else %}
                        255
                      {% endif %}
                    raw_delta: "{{ (step_size * sensitivity) | float }}"
                    clamped_delta: >
                      {% if raw_delta > max_delta %}{{ max_delta }}{% else %}{{ raw_delta }}{% endif %}
                    new_raw: "{{ current_level | float - clamped_delta }}"
                    above_min: "{{ new_raw if new_raw > min_level else min_level }}"
                    new_level: "{{ [above_min, 255] | min | round(0) }}"
                - service: light.turn_on
                  target:
                    entity_id: "{{ entity_id }}"
                  data:
                    brightness: "{{ new_level }}"
                    transition: "{{ rot_trans }}"

      ######################################################################
      # Долгое нажатие: начало удержания (move на cluster 8)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ cluster_id == 8 and command == 'move' }}"
        sequence:
          # Ждем отпускание (stop) или истечение hold_ms, затем ставим double_bright
          - wait_for_trigger:
              - platform: event
                event_type: zha_event
                event_data:
                  device_id: !input controller
                  cluster_id: 8
                  command: stop
            timeout:
              milliseconds: "{{ hold_ms }}"
            continue_on_timeout: true

          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_pct: "{{ double_bright }}"
              transition: "{{ press_trans }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: info
                      message: >
                        [Long Press] applied double_bright={{ double_bright }} (stop or timeout {{ hold_ms }}ms)

      ######################################################################
      # Одиночный клик (toggle)
      ######################################################################
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' and cluster_id == 6 }}"
        sequence:
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_pct: "{{ single_bright }}"
              transition: "{{ press_trans }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: info
                      message: >
                        [Single Click] brightness_pct={{ single_bright }}
