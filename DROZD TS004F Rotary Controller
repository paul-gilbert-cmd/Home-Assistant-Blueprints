blueprint:
  name: TS004F Rotary Controller (multi-target, improved steps)
  description: Универсальная автоматизация для поворотного контроллера Xiaomi/Aqara TS004F.
    Поддерживает выбор нескольких целевых light-устройств, опциональный выбор ZHA-device и
    адаптивный шаг по скорости поворота.
  domain: automation
  input:
    zha_device:
      name: ZHA device (опционально)
      description: "Можно выбрать устройство интеграции ZHA — удобно для UI, но сравнение IEEE надёжнее вводить вручную."
      selector:
        device:
          integration: zha

    device_ieee:
      name: IEEE адрес TS004F (опционально)
      description: "Например: a4:c1:38:aa:56:c4:e8:76. Если оставить пустым — автоматизация сработает для любого устройства."
      selector:
        text:

    target_lights:
      name: Целевые устройства (можно выбрать несколько)
      selector:
        entity:
          domain: light
          multiple: true

    brightness_presets:
      name: Целевые уровни яркости
      default: [51, 102, 153, 204, 255]
      selector:
        object:

    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0
          max: 10
          step: 0.1

variables:
  # Входы
  device_ieee_input: !input device_ieee
  target_list: !input target_lights

  # Парсим поля из события zha_event и приводим к числам где нужно
  cluster_id: "{{ trigger.event.data.cluster_id | int }}"
  command: "{{ trigger.event.data.command }}"
  # step_mode может быть в params.step_mode или в args[0]; берём разумный fallback
  step_mode: >
    {{ (trigger.event.data.params.step_mode if (trigger.event.data.params is defined and trigger.event.data.params.step_mode is not none)
        else (trigger.event.data.args[0] if (trigger.event.data.args is defined and (trigger.event.data.args | length) > 0) else 0)) | int }}
  # step_size аналогично: params.step_size или args[1]
  step_size: >
    {{ (trigger.event.data.params.step_size if (trigger.event.data.params is defined and trigger.event.data.params.step_size is not none)
        else (trigger.event.data.args[1] if (trigger.event.data.args is defined and (trigger.event.data.args | length) > 1) else 0)) | int }}

  # Преобразуем presets к списку int на всякий случай
  presets: "{{ input.brightness_presets | default([51,102,153,204,255]) | map('int') | list }}"

  # Первый target используется для чтения текущей яркости; остальным команда будет применена одинаково
  first_target: "{{ (target_list[0] if (target_list is iterable and (target_list | length) > 0) else '') }}"
  current_brightness: "{{ (state_attr(first_target, 'brightness') | default(0)) | int }}"

  # Индекс ближайшего пресета
  current_index: >
    {%- set closest = 0 -%}
    {%- for i in range(presets | length) -%}
      {%- if (presets[i] - current_brightness) | abs < (presets[closest] - current_brightness) | abs -%}
        {%- set closest = i -%}
      {%- endif -%}
    {%- endfor -%}
    {{ closest }}

  # Разумная адаптация шага (чем больше step_size — тем крупнее шаг)
  step_increment: >
    {%- set s = step_size | int -%}
    {%- if s <= 6 -%}
      1
    {%- elif s <= 15 -%}
      1
    {%- elif s <= 30 -%}
      2
    {%- elif s <= 60 -%}
      3
    {%- else -%}
      4
    {%- endif -%}

  # направление: step_mode == 1 => CCW (против часовой)
  is_ccw: "{{ step_mode | int == 1 }}"

trigger:
  - platform: event
    event_type: zha_event

condition:
  # Если указан IEEE — фильтруем по нему. Если пусто — пропускаем любые устройства.
  - condition: template
    value_template: >
      {% if device_ieee_input | trim != '' %}
        {{ trigger.event.data.device_ieee == device_ieee_input }}
      {% else %}
        true
      {% endif %}
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      # Кнопка toggle (cluster 6)
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' }}"
        sequence:
          - service: light.toggle
            target:
              entity_id: !input target_lights

      # Поворот по часовой: увеличиваем индекс
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and not is_ccw }}"
        sequence:
          - variables:
              new_idx: "{{ [current_index + step_increment, (presets | length) - 1] | min }}"
              brightness_value: "{{ presets[new_idx] | int }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ brightness_value }}"
                      transition: !input transition_speed
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: !input transition_speed

      # Поворот против часовой: уменьшаем индекс
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and is_ccw }}"
        sequence:
          - variables:
              new_idx: "{{ [current_index - step_increment, 0] | max }}"
              brightness_value: "{{ presets[new_idx] | int }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ brightness_value }}"
                      transition: !input transition_speed
              - conditions:
                  - condition: template
                    value_template: "{{ brightness_value == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: !input transition_speed
