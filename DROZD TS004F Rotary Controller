blueprint:
  name: TS004F Rotary Controller
  description: Универсальная автоматизация для поворотного контроллера Xiaomi/Aqara TS004F с выбором целевой яркости
  domain: automation
  input:
    device_id:
      name: Устройство TS004F
      description: Выбери ZHA устройство TS004F
      selector:
        device:
          integration: zha
          manufacturer: Lumi
          model: "TS004F"
    
    target_light:
      name: Целевое устройство
      description: Лампа или группа ламп для управления яркостью
      selector:
        entity:
          domain: light
    
    brightness_presets:
      name: Целевые уровни яркости
      description: Список желаемых уровней яркости (0-255). По умолчанию 5 уровней
      default: [51, 102, 153, 204, 255]
      selector:
        object:
    
    transition_speed:
      name: Скорость переходов
      description: Время плавного перехода между уровнями (в секундах)
      default: 0.5
      selector:
        number:
          min: 0
          max: 5
          step: 0.1
          unit_of_measurement: "s"

variables:
  device_ieee: "{{ trigger.event.data.device_ieee }}"
  cluster_id: "{{ trigger.event.data.cluster_id }}"
  command: "{{ trigger.event.data.command }}"
  step_mode: "{{ trigger.event.data.params.get('step_mode') }}"
  step_size: "{{ trigger.event.data.args[1] if trigger.event.data.args|length > 1 else 0 }}"
  transition_time: "{{ trigger.event.data.params.get('transition_time', 1) }}"
  
  # Текущая яркость целевого устройства (0-255)
  current_brightness: "{{ state_attr(input.target_light, 'brightness') | default(0, true) | int }}"
  
  # Список целевых уровней яркости
  presets: "{{ input.brightness_presets | default([51, 102, 153, 204, 255]) }}"
  
  # Поиск текущего индекса в списке целевых уровней
  current_index: >
    {%- set ns = namespace(index=0) -%}
    {%- for preset in presets -%}
      {%- if (current_brightness - preset) | abs <= 25 -%}
        {%- set ns.index = loop.index0 -%}
      {%- endif -%}
    {%- endfor -%}
    {{ ns.index }}
  
  # Расчёт скорости на основе step_size
  # step_size: медленный поворот = меньше значение, быстрый = больше значение
  # Нормализуем: медленно < 15, среднее 15-20, быстро > 20
  rotation_speed: >
    {%- if step_size < 15 -%}
      slow
    {%- elif step_size < 22 -%}
      medium
    {%- else -%}
      fast
    {%- endif -%}

trigger:
  - platform: event
    event_type: zha_event
    event_
      device_ieee: !input device_id
      # Фильтруем только наши события: toggle (нажатие) и step (поворот)

condition:
  - condition: template
    value_template: >
      {{ command in ['toggle', 'step'] and cluster_id in [6, 8] }}

action:
  # ========== НАЖАТИЕ КНОПКИ ==========
  - if:
      - condition: template
        value_template: "{{ command == 'toggle' and cluster_
