blueprint:
  name: DROZD TS004F Rotary Controller — linear brightness & button action (fixed templates)
  description: >
    TS004F rotary controller (ZHA). Линейная регулировка яркости,
    multiple target lights, selectable button action. Исправлены ошибки шаблонов
    и восстановлен селектор ZHA-устройства.
  domain: automation
  input:
    zha_device:
      name: ZHA device (опционально)
      description: "Выберите устройство ZHA (будет сравнение по device_id)."
      selector:
        device:
          integration: zha

    device_ieee:
      name: IEEE адрес TS004F (опционально)
      description: "Например: a4:c1:38:aa:56:c4:e8:76. Если заполнено — сравниваем по IEEE."
      selector:
        text:

    target_lights:
      name: Целевые устройства (можно выбрать несколько)
      selector:
        entity:
          domain: light
          multiple: true

    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0
          max: 10
          step: 0.1

    brightness_multiplier:
      name: Множитель дельты яркости
      description: "Множитель для вычисления изменения яркости из step_size."
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 10
          step: 0.1

    min_brightness:
      name: Минимальная яркость (0 = выключать)
      default: 1
      selector:
        number:
          min: 0
          max: 254
          step: 1

    button_action:
      name: Действие при нажатии кнопки
      description: "Действие при событии toggle (нажатие)."
      default: toggle
      selector:
        select:
          options:
            - toggle
            - turn_on
            - turn_off
            - no_action

variables:
  # входные значения
  device_ieee_input: !input device_ieee
  zha_device_input: !input zha_device
  target_list: !input target_lights
  transition_speed: !input transition_speed
  brightness_multiplier: !input brightness_multiplier
  min_brightness: !input min_brightness
  button_action: !input button_action

  # простые поля из события
  cluster_id: "{{ trigger.event.data.cluster_id | int }}"
  command: "{{ trigger.event.data.command }}"

  # step_mode: params.step_mode OR args[0] OR 0 — безопасно через set/if
  step_mode: >
    {% set _sm = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_mode is not none %}
      {% set _sm = trigger.event.data.params.step_mode %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 0 %}
      {% set _sm = trigger.event.data.args[0] %}
    {% endif %}
    {{ _sm | int }}

  # step_size: params.step_size OR args[1] OR 0 — безопасно через set/if
  step_size: >
    {% set _ss = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_size is not none %}
      {% set _ss = trigger.event.data.params.step_size %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 1 %}
      {% set _ss = trigger.event.data.args[1] %}
    {% endif %}
    {{ _ss | int }}

  # первый target для чтения текущей яркости
  first_target: >
    {% if target_list is iterable and (target_list | length) > 0 %}
      {{ target_list[0] }}
    {% else %}
      {{ '' }}
    {% endif %}

  current_brightness: >
    {% set ft = (target_list[0] if (target_list is iterable and (target_list | length) > 0) else '') %}
    {{ (state_attr(ft, 'brightness') | default(0)) | int }}

  # направление: step_mode == 1 => CCW (уменьшение)
  is_ccw: "{{ step_mode | int == 1 }}"

  # линейная дельта: пропорциональна step_size * multiplier, минимум 1
  delta: >
    {% set d = (step_size | int) * (brightness_multiplier | float) %}
    {% if (d | int) < 1 %}
      1
    {% else %}
      {{ d | int }}
    {% endif %}

trigger:
  - platform: event
    event_type: zha_event

condition:
  # Проверка устройства: приоритет device_ieee, затем zha_device (device_id), иначе разрешаем
  - condition: template
    value_template: >
      {% if device_ieee_input | trim != '' %}
        {{ (trigger.event.data.device_ieee | default('')) == device_ieee_input }}
      {% elif zha_device_input | default('') != '' %}
        {{ (trigger.event.data.device_id | default('')) == zha_device_input }}
      {% else %}
        true
      {% endif %}
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      # Button press handling (cluster 6 toggle)
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'toggle' }}"
                sequence:
                  - service: light.toggle
                    target:
                      entity_id: !input target_lights
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'turn_on' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'turn_off' }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'no_action' }}"
                sequence:
                  - variables:
                      _debug: "no action for toggle"

      # Rotation: linear brightness change (cluster 8, command step)
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 }}"
        sequence:
          - variables:
              raw_new: >
                {% set cb = current_brightness | int %}
                {% set d = delta | int %}
                {% if step_mode | int == 1 %}
                  {{ cb - d }}
                {% else %}
                  {{ cb + d }}
                {% endif %}
              new_brightness: >
                {% set nb = raw_new | int %}
                {% if nb <= 0 %}
                  0
                {% elif nb > 255 %}
                  255
                {% else %}
                  {{ nb }}
                {% endif %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ new_brightness == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ new_brightness > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ [new_brightness, min_brightness] | max }}"
                      transition: "{{ transition_speed }}"
