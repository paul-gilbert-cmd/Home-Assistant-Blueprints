blueprint:
  name: TS004F Rotary Controller — linear brightness & button action (tuned, 100% button)
  description: >
    TS004F rotary controller (ZHA). Линейная регулировка яркости с настраиваемой чувствительностью,
    множественные цели (lights) и выбор действия при нажатии кнопки.
    Добавлена опция "яркость 100%" для действия при нажатии.
  domain: automation
  input:
    zha_device:
      name: ZHA device (опционально)
      description: "Выберите устройство ZHA (будет сравнение по device_id). Если не указано — автоматизация реагирует на все устройства."
      selector:
        device:
          integration: zha

    target_lights:
      name: Целевые устройства (можно выбрать несколько)
      selector:
        entity:
          domain: light
          multiple: true

    transition_speed:
      name: Скорость переходов (сек)
      default: 0.5
      selector:
        number:
          min: 0
          max: 10
          step: 0.1

    brightness_multiplier:
      name: Множитель дельты яркости
      description: "Умножает влияние step_size. Увеличьте для более резкого отклика."
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 10
          step: 0.1

    sensitivity_divisor:
      name: Чувствительность (делитель)
      description: "Делит (step_size * multiplier). Чем больше — тем мягче изменение. Рекомендуемое значение по умолчанию 4."
      default: 4.0
      selector:
        number:
          min: 0.1
          max: 20
          step: 0.1

    min_brightness:
      name: Минимальная яркость (0 = разрешать выключение)
      default: 1
      selector:
        number:
          min: 0
          max: 254
          step: 1

    button_action:
      name: Действие при нажатии кнопки
      description: "Действие при событии toggle (нажатие)."
      default: toggle
      selector:
        select:
          options:
            - toggle
            - turn_on
            - turn_off
            - brightness_100
            - no_action

variables:
  # inputs
  zha_device_input: !input zha_device
  target_list: !input target_lights
  transition_speed: !input transition_speed
  brightness_multiplier: !input brightness_multiplier
  sensitivity_divisor: !input sensitivity_divisor
  min_brightness: !input min_brightness
  button_action: !input button_action

  # fields from event (safe parsing)
  cluster_id: "{{ trigger.event.data.cluster_id | int }}"
  command: "{{ trigger.event.data.command }}"

  # step_mode: params.step_mode OR args[0] OR 0
  step_mode: >
    {% set _sm = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_mode is not none %}
      {% set _sm = trigger.event.data.params.step_mode %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 0 %}
      {% set _sm = trigger.event.data.args[0] %}
    {% endif %}
    {{ _sm | int }}

  # step_size: params.step_size OR args[1] OR 0
  step_size: >
    {% set _ss = 0 %}
    {% if trigger.event.data.params is defined and trigger.event.data.params.step_size is not none %}
      {% set _ss = trigger.event.data.params.step_size %}
    {% elif trigger.event.data.args is defined and (trigger.event.data.args | length) > 1 %}
      {% set _ss = trigger.event.data.args[1] %}
    {% endif %}
    {{ _ss | int }}

  # transition_time from event if present (may help tuning)
  transition_time_from_event: >
    {% if trigger.event.data.params is defined and trigger.event.data.params.transition_time is not none %}
      {{ trigger.event.data.params.transition_time | int }}
    {% else %}
      0
    {% endif %}

  # first target to read brightness
  first_target: >
    {% if target_list is iterable and (target_list | length) > 0 %}
      {{ target_list[0] }}
    {% else %}
      {{ '' }}
    {% endif %}

  current_brightness: >
    {% set ft = (target_list[0] if (target_list is iterable and (target_list | length) > 0) else '') %}
    {{ (state_attr(ft, 'brightness') | default(0)) | int }}

  # compute delta: floor((step_size * multiplier) / sensitivity_divisor), min 1
  delta: >
    {% set raw = (step_size | int) * (brightness_multiplier | float) / (sensitivity_divisor | float) %}
    {% if (raw | int) < 1 %}
      1
    {% else %}
      {{ raw | int }}
    {% endif %}

trigger:
  - platform: event
    event_type: zha_event

condition:
  # if zha_device selected — filter by device_id, else allow all
  - condition: template
    value_template: >
      {% if zha_device_input | default('') != '' %}
        {{ (trigger.event.data.device_id | default('')) == zha_device_input }}
      {% else %}
        true
      {% endif %}
  - condition: template
    value_template: "{{ cluster_id in [6, 8] }}"

action:
  - choose:
      # button
      - conditions:
          - condition: template
            value_template: "{{ command == 'toggle' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'toggle' }}"
                sequence:
                  - service: light.toggle
                    target:
                      entity_id: !input target_lights
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'turn_on' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'turn_off' }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'brightness_100' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: 255
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ button_action == 'no_action' }}"
                sequence:
                  - variables:
                      _debug: "no action for toggle"

      # rotation -> linear change
      - conditions:
          - condition: template
            value_template: "{{ command == 'step' and cluster_id == 8 }}"
        sequence:
          - variables:
              raw_new: >
                {% set cb = current_brightness | int %}
                {% set d = delta | int %}
                {% if step_mode | int == 1 %}
                  {{ cb - d }}
                {% else %}
                  {{ cb + d }}
                {% endif %}
              intended: >
                {% set nb = raw_new | int %}
                {% if nb < 0 %}
                  0
                {% elif nb > 255 %}
                  255
                {% else %}
                  {{ nb }}
                {% endif %}
              # final: if intended == 0 -> allow off only when min_brightness == 0,
              # otherwise ensure at least min_brightness; and if 0 < intended < min_brightness -> set to min_brightness
              final_brightness: >
                {% set ib = (min_brightness | int) %}
                {% if intended == 0 %}
                  {% if ib == 0 %}
                    0
                  {% else %}
                    {{ ib }}
                  {% endif %}
                {% else %}
                  {% if ib > 0 and intended < ib %}
                    {{ ib }}
                  {% else %}
                    {{ intended }}
                  {% endif %}
                {% endif %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ final_brightness == 0 }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: !input target_lights
                    data:
                      transition: "{{ transition_speed }}"
              - conditions:
                  - condition: template
                    value_template: "{{ final_brightness > 0 }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: !input target_lights
                    data:
                      brightness: "{{ final_brightness }}"
                      transition: "{{ transition_speed }}"
